{% extends "base.html" %}
{% load static %}

{% block title %}Subscriptions - DreamWedAI{% endblock %}

{% block css %}
{{ block.super }}
<link rel="canonical" href="{{ request.scheme }}://{{ request.get_host }}{% url 'subscriptions:pricing' %}">
<style>
/* Keep 3 months free badge */
.savings-badge {
  display: inline-block;
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 15px;
  font-size: 0.85rem;
  font-weight: 700;
  margin-left: 0.5rem;
  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

/* Holiday Banner Styling */
.holiday-promo {
  background: linear-gradient(135deg, #c41e3a, #165b33);
  color: white;
  padding: 2rem;
  text-align: center;
  border-bottom: 4px solid gold;
  margin-bottom: 2rem;
}
.holiday-promo h2 {
  font-size: 2.5rem;
  font-weight: 800;
  margin: 0 0 1rem;
}
.holiday-badge {
  display: inline-block;
  background: gold;
  color: #c41e3a;
  padding: 1rem 2rem;
  border-radius: 50px;
  font-size: 1.8rem;
  font-weight: 900;
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}
@media (max-width: 768px) {
  .holiday-promo h2 { font-size: 1.5rem; }
  .holiday-badge { font-size: 1.2rem; padding: 0.75rem 1.5rem; }
}
</style>
{% endblock %}

{% block content %}

<!-- Holiday Promotion Banner -->
<div class="holiday-promo">
  <h2>üéÅ Holiday Special üéÅ</h2>
  <div class="holiday-badge">‚ö° 2X TOKENS ‚ö°</div>
  <p style="font-size: 1.3rem; margin: 1rem 0 0;">
    Subscribe now and get <strong>DOUBLE tokens every month ‚Äî FOREVER!</strong><br>
    <small style="opacity: 0.9;">Limited time offer ‚Ä¢ Ends December 31st</small>
  </p>
</div>

<div class="pricing-page">

  <!-- Hero Section -->
  <section class="pricing-hero py-5 bg-gradient-to-b from-white to-light">
    <div class="container">
      <div class="row justify-content-center text-center">
        <div class="col-lg-8">
          <h1 class="display-4 fw-bold mb-3">
            Choose Your Perfect Plan
          </h1>
          <p class="lead text-muted mb-4">
           Get the tools needed for the perfect wedding.
          </p>
          
          <!-- Billing Toggle with Rose Styling -->
          <div class="billing-toggle mb-5">
            <div class="btn-group" role="group" aria-label="Billing period">
              <input type="radio" class="btn-check" name="billing" id="monthly" checked>
              <label class="btn btn-outline-rose" for="monthly">Monthly Billing</label>
              
              <input type="radio" class="btn-check" name="billing" id="yearly">
              <label class="btn btn-outline-rose" for="yearly">
                Yearly Billing 
                <span class="badge bg-success ms-2">3 Months Free!</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Error Handling -->
  {% if error %}
  <div class="container">
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      {{ error }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  </div>
  {% endif %}

  <!-- Pricing Cards -->
  <section class="pricing-cards py-5">
    <div class="container">
      <div class="row g-4 align-items-stretch">
        {% for product in products %}
        <div class="col-lg-4 col-md-6">
          <div class="card h-100 pricing-card {% if product.highlight %}featured-card shadow-lg{% else %}shadow{% endif %} position-relative">
            
            {% if product.highlight %}
            <div class="card-header bg-gradient-rose text-white text-center py-2">
              <small class="text-uppercase fw-bold letter-spacing-1">
                <i class="bi bi-star-fill me-1"></i> Most Popular
              </small>
            </div>
            {% endif %}
            
            <div class="card-body d-flex flex-column p-4">
              <!-- Product Name & Description -->
              <div class="text-center mb-4">
                <h3 class="card-title fw-bold mb-2">{{ product.name }}</h3>
                {% if product.description %}
                <p class="text-muted small">{{ product.description }}</p>
                {% endif %}
              </div>
              
              <!-- Pricing Display - Clean, No Strikethrough -->
              <div class="pricing-display text-center mb-4">
                <!-- Monthly Pricing -->
                <div class="monthly-price" data-product-id="{{ product.id }}">
                  {% if product.prices.monthly %}
                  <div class="price-amount">
                    <div class="d-flex align-items-baseline justify-content-center">
                      <span class="currency-large">$</span>
                      <span class="price-large fw-bold">{{ product.prices.monthly.amount|floatformat:0 }}</span>
                      <span class="period-large text-muted">/month</span>
                    </div>
                  </div>
                  <small class="text-muted d-block mt-3">Taxes included ‚Ä¢ Cancel anytime</small>
                  {% if product.prices.monthly.display_name %}
                  <small class="text-muted">{{ product.prices.monthly.display_name }}</small>
                  {% endif %}
                  {% else %}
                  <div class="text-muted">Monthly not available</div>
                  {% endif %}
                </div>
                
                <!-- Yearly Pricing (Hidden by default) -->
                <div class="yearly-price d-none" data-product-id="{{ product.id }}">
                  {% if product.prices.yearly %}
                  <div class="price-amount">
                    <div class="d-flex align-items-baseline justify-content-center">
                      <span class="currency-large">$</span>
                      <span class="price-large fw-bold">{{ product.prices.yearly.amount|floatformat:0 }}</span>
                      <span class="period-large text-muted">/year</span>
                    </div>
                    
                    <!-- 3 MONTHS FREE badge below price -->
                    <div class="badge bg-success fw-bold px-3 py-2 mt-2">
                      <i class="bi bi-gift-fill me-1"></i>
                      3 MONTHS FREE!
                    </div>
                  </div>
                  <small class="text-muted d-block mt-3">Taxes included ‚Ä¢ Best value</small>
                  {% if product.prices.yearly.display_name %}
                  <small class="text-muted">{{ product.prices.yearly.display_name }}</small>
                  {% endif %}
                  {% else %}
                  <div class="text-muted">Yearly not available</div>
                  {% endif %}
                </div>
              </div>
              
              
              <!-- Features List -->
              {% if product.features_list %}
              <ul class="list-unstyled feature-list mb-4 flex-grow-1">
                {% for feature in product.features_list %}
                <li class="mb-3 d-flex align-items-start">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1 flex-shrink-0"></i>
                  <span>{{ feature }}</span>
                </li>
                {% endfor %}
              </ul>
              {% endif %}
              
              <!-- CTA Buttons -->
              <div class="mt-auto">
                {% if user.is_authenticated %}
                  <!-- Monthly Button -->
                  <form method="post" action="{% url 'subscriptions:create_checkout_session' %}" class="checkout-form monthly-button" data-product-id="{{ product.id }}">
                    {% csrf_token %}
                    <input type="hidden" name="price_id" value="{{ product.prices.monthly.id }}">
                    <button type="submit" class="btn btn-lg w-100 {% if product.highlight %}btn-gradient-primary{% else %}btn-outline-primary{% endif %}">
                      {% if product.highlight %}
                      <i class="bi bi-star-fill me-2"></i>
                      {% endif %}
                      Get Started
                    </button>
                  </form>
                  
                  <!-- Yearly Button (Hidden by default) -->
                  <form method="post" action="{% url 'subscriptions:create_checkout_session' %}" class="checkout-form yearly-button d-none" data-product-id="{{ product.id }}">
                    {% csrf_token %}
                    <input type="hidden" name="price_id" value="{{ product.prices.yearly.id }}">
                    <button type="submit" class="btn btn-lg w-100 {% if product.highlight %}btn-gradient-primary{% else %}btn-outline-primary{% endif %}">
                      {% if product.highlight %}
                      <i class="bi bi-star-fill me-2"></i>
                      {% endif %}
                      Get Started
                    </button>
                  </form>
                {% else %}
                  <!-- Guest Checkout - Monthly -->
                  <a href="{% url 'subscriptions:guest_checkout' %}?price_id={{ product.prices.monthly.id }}" 
                     class="btn btn-lg w-100 {% if product.highlight %}btn-gradient-primary{% else %}btn-outline-primary{% endif %} monthly-button">
                    {% if product.highlight %}
                    <i class="bi bi-star-fill me-2"></i>
                    {% endif %}
                    Get Started
                  </a>
                  
                  <!-- Guest Checkout - Yearly (Hidden by default) -->
                  <a href="{% url 'subscriptions:guest_checkout' %}?price_id={{ product.prices.yearly.id }}" 
                     class="btn btn-lg w-100 {% if product.highlight %}btn-gradient-primary{% else %}btn-outline-primary{% endif %} yearly-button d-none">
                    {% if product.highlight %}
                    <i class="bi bi-star-fill me-2"></i>
                    {% endif %}
                    Get Started
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- Trust Badges -->
      <div class="row mt-5 pt-4 border-top">
        <div class="col-12">
          <div class="row text-center g-4">
            <div class="col-md-3 col-6">
              <div class="trust-badge">
                <i class="bi bi-shield-check text-primary display-4 mb-2"></i>
                <p class="small mb-0 fw-semibold">Secure Payment</p>
                <p class="small text-muted">256-bit SSL Encryption</p>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="trust-badge">
                <i class="bi bi-arrow-repeat text-success display-4 mb-2"></i>
                <p class="small mb-0 fw-semibold">Cancel Anytime</p>
                <p class="small text-muted">No Questions Asked</p>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="trust-badge">
                <i class="bi bi-headset text-info display-4 mb-2"></i>
                <p class="small mb-0 fw-semibold">24/7 Support</p>
                <p class="small text-muted">Always Here to Help</p>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="trust-badge">
                <i class="bi bi-heart-fill text-danger display-4 mb-2"></i>
                <p class="small mb-0 fw-semibold">Made for Couples</p>
                <p class="small text-muted">Built by Wedding Pros</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="faq-section py-5 bg-light">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <h2 class="text-center fw-bold mb-4">Frequently Asked Questions</h2>
          
          <div class="accordion" id="faqAccordion">
            <div class="accordion-item border-0 mb-3 shadow-sm">
              <h3 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                  <i class="bi bi-question-circle me-2 text-primary"></i>
                  What payment methods do you accept?
                </button>
              </h3>
              <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                <div class="accordion-body">
                  We accept all major credit cards (Visa, MasterCard, American Express) through our secure payment processor, Stripe. Your payment information is encrypted and never stored on our servers.
                </div>
              </div>
            </div>
            
            <div class="accordion-item border-0 mb-3 shadow-sm">
              <h3 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                  <i class="bi bi-question-circle me-2 text-primary"></i>
                  Can I change my plan later?
                </button>
              </h3>
              <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                <div class="accordion-body">
                  Yes! You can upgrade or downgrade your plan at any time from your account settings. Changes take effect immediately, and we'll prorate the difference in cost.
                </div>
              </div>
            </div>
            
            <div class="accordion-item border-0 mb-3 shadow-sm">
              <h3 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                  <i class="bi bi-question-circle me-2 text-primary"></i>
                  What happens to my images if I cancel?
                </button>
              </h3>
              <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                <div class="accordion-body">
                 When you cancel, your account will revert to the free tier with limited storage.  We remove the older files frst.  </div>
              </div>
            </div>
            
            <div class="accordion-item border-0 mb-3 shadow-sm">
              <h3 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                  <i class="bi bi-question-circle me-2 text-primary"></i>
                  Do unused transformations roll over?
                </button>
              </h3>
              <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                <div class="accordion-body">
                  No, transformation credits reset at the start of each billing cycle. We recommend choosing a plan that matches your expected monthly usage. You can always upgrade if you need more transforms.
                </div>
              </div>
            </div>
            
            <div class="accordion-item border-0 mb-3 shadow-sm">
              <h3 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq5">
                  <i class="bi bi-question-circle me-2 text-primary"></i>
                  Is there a free trial?
                </button>
              </h3>
              <div id="faq5" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                <div class="accordion-body">
                  Yes! All new users get 3 free transformations to try out our service. No credit card required. Simply sign up and start seeing your wedding right away.
                </div>
              </div>
            </div>
            
            <div class="accordion-item border-0 mb-3 shadow-sm">
              <h3 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq6">
                  <i class="bi bi-question-circle me-2 text-primary"></i>
                  What about the yearly savings?
                </button>
              </h3>
              <div id="faq6" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                <div class="accordion-body">
                  When you choose yearly billing, you get 3 months completely free! That's 25% off compared to paying monthly. It's perfect if you're planning your wedding over several months and want to save money while accessing all features.
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- Guest Checkout Benefits Section -->
  {% if not user.is_authenticated %}
  <section class="guest-benefits py-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <h2 class="text-center fw-bold mb-4">No Account? No Problem!</h2>
          <p class="text-center text-muted mb-5">Start planning your wedding aethetics right away with guest checkout</p>
          
          <div class="row g-4">
            <div class="col-md-4">
              <div class="benefit-item">
                <div class="benefit-icon">
                  <i class="bi bi-lightning-charge-fill"></i>
                </div>
                <h5 class="fw-bold mb-2">Instant Access</h5>
                <p class="text-muted small">Skip the signup process and start transforming immediately</p>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="benefit-item">
                <div class="benefit-icon">
                  <i class="bi bi-shield-check"></i>
                </div>
                <h5 class="fw-bold mb-2">Secure & Private</h5>
                <p class="text-muted small">Your payment is encrypted and your photos are kept private</p>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="benefit-item">
                <div class="benefit-icon">
                  <i class="bi bi-envelope-heart"></i>
                </div>
                <h5 class="fw-bold mb-2">Email Access</h5>
                <p class="text-muted small">Get secure email access to view and download your transformed images</p>
              </div>
            </div>
          </div>
          
          <div class="text-center mt-4">
            <p class="small text-muted">
              <i class="bi bi-info-circle me-1"></i>
              You can create an account anytime to manage your subscription and view billing history
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>
  {% endif %}

</div>

<!-- Stripe JS -->
<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const stripe = Stripe('{{ stripe_public_key }}');
  
  // Billing toggle functionality
  const monthlyRadio = document.getElementById('monthly');
  const yearlyRadio = document.getElementById('yearly');
  
  function togglePricing(showYearly) {
    // Toggle all pricing displays
    document.querySelectorAll('.monthly-price').forEach(el => {
      el.classList.toggle('d-none', showYearly);
    });
    document.querySelectorAll('.yearly-price').forEach(el => {
      el.classList.toggle('d-none', !showYearly);
    });
    
    // Toggle all buttons
    document.querySelectorAll('.monthly-button').forEach(el => {
      el.classList.toggle('d-none', showYearly);
    });
    document.querySelectorAll('.yearly-button').forEach(el => {
      el.classList.toggle('d-none', !showYearly);
    });
  }
  
  monthlyRadio?.addEventListener('change', () => togglePricing(false));
  yearlyRadio?.addEventListener('change', () => togglePricing(true));
  
  // Prevent duplicate submissions
  let isSubmitting = false;
  
  // Handle checkout form submissions
  const checkoutForms = document.querySelectorAll('.checkout-form');
  checkoutForms.forEach(form => {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (isSubmitting) {
        console.log('Form submission already in progress, ignoring duplicate request');
        return;
      }
      
      isSubmitting = true;
      const submitButton = form.querySelector('button[type="submit"]');
      const originalText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
      
      form.classList.add('submitting');
      
      try {
        const formData = new FormData(form);
        const priceId = formData.get('price_id');
        console.log('Submitting checkout with price_id:', priceId);
        
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          }
        });
        
        const data = await response.json();
        
        if (data.sessionId) {
          console.log('Redirecting to Stripe checkout with session:', data.sessionId);
          const result = await stripe.redirectToCheckout({
            sessionId: data.sessionId
          });
          
          if (result.error) {
            console.error('Stripe redirect error:', result.error);
            alert(result.error.message);
            resetFormState();
          }
        } else if (data.error) {
          console.error('Checkout creation error:', data.error);
          alert('Error: ' + data.error);
          resetFormState();
        } else {
          console.error('Unexpected response format:', data);
          alert('Unexpected response from server. Please try again.');
          resetFormState();
        }
      } catch (error) {
        console.error('Network/fetch error:', error);
        alert('Network error occurred. Please check your connection and try again.');
        resetFormState();
      }
      
      function resetFormState() {
        isSubmitting = false;
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
        form.classList.remove('submitting');
      }
    });
  });
});
</script>

<style>
.pricing-card {
  border: none;
  border-radius: 12px;
  transition: all 0.3s ease;
  overflow: hidden;
}

.pricing-card:hover {
  transform: translateY(-10px);
  box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
}

.featured-card {
  border: 2px solid var(--bs-primary);
  position: relative;
}

.featured-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--bs-cyan), var(--bs-primary), var(--bs-rose));
}

/* PRICE STYLING - CLEAN AND LARGE */
.currency-large {
  font-size: 2.5rem;
  font-weight: 600;
  margin-right: 0.25rem;
}

.price-large {
  font-size: 4.5rem;
  line-height: 1;
  letter-spacing: -0.02em;
}

.period-large {
  font-size: 1.25rem;
  margin-left: 0.25rem;
  align-self: flex-end;
  margin-bottom: 0.5rem;
}

.feature-list li {
  font-size: 0.95rem;
}

/* Billing Toggle */
.billing-toggle .btn-check:checked + .btn-outline-rose {
  background: var(--electric-rose);
  border-color: var(--electric-rose);
  color: white;
}

.btn-outline-rose {
  border-color: var(--electric-rose);
  color: var(--electric-rose);
  font-weight: 600;
  border-radius: 25px;
  transition: all 0.3s ease;
}

.btn-outline-rose:hover {
  background: var(--electric-rose);
  border-color: var(--electric-rose);
  color: white;
  transform: translateY(-2px);
}

.trust-badge {
  padding: 1rem;
  transition: transform 0.2s;
}

.trust-badge:hover {
  transform: scale(1.05);
}

.letter-spacing-1 {
  letter-spacing: 0.1em;
}

.bg-gradient-to-b {
  background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
}

.checkout-form.submitting {
  opacity: 0.7;
  pointer-events: none;
}

.checkout-form button[disabled] {
  pointer-events: none;
}

.checkout-form.submitting .card {
  position: relative;
}

.checkout-form.submitting .card::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  border-radius: inherit;
  z-index: 1;
}

/* Guest checkout benefits styling */
.guest-benefits {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.benefit-item {
  text-align: center;
  padding: 20px;
}

.benefit-icon {
  width: 60px;
  height: 60px;
  background: linear-gradient(45deg, var(--electric-rose), var(--bright-cyan));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: white;
  margin: 0 auto 15px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
</style>
{% endblock %}