{% extends "base.html" %}
{% load static %}

{% block title %}Pricing - DreamWedAI{% endblock %}

{% block content %}
<div class="pricing-page">
  <!-- Hero Section -->
  <section class="pricing-hero py-5 bg-gradient-to-b from-white to-light">
    <div class="container">
      <div class="row justify-content-center text-center">
        <div class="col-lg-8">
          <h1 class="display-4 fw-bold mb-3">
            Choose Your Perfect Plan
          </h1>
          <p class="lead text-muted mb-4">
            Transform your wedding venue with AI-powered visualizations
          </p>
          
          <!-- Billing Toggle -->
          <div class="billing-toggle mb-5">
            <div class="btn-group" role="group" aria-label="Billing period">
              <input type="radio" class="btn-check" name="billing" id="monthly" checked>
              <label class="btn btn-outline-primary" for="monthly">Monthly Billing</label>
              
              <input type="radio" class="btn-check" name="billing" id="yearly">
              <label class="btn btn-outline-primary" for="yearly">Yearly Billing <span class="badge bg-success ms-2">Save!</span></label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Error Handling -->
  {% if error %}
  <div class="container">
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      {{ error }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  </div>
  {% endif %}

  <!-- Pricing Cards -->
  <section class="pricing-cards py-5">
    <div class="container">
      <div class="row g-4 align-items-stretch">
        {% for product in products %}
        <div class="col-lg-4 col-md-6">
          <div class="card h-100 pricing-card {% if product.highlight %}featured-card shadow-lg{% else %}shadow{% endif %}">
            {% if product.highlight %}
            <div class="card-header bg-gradient-rose text-white text-center py-2">
              <small class="text-uppercase fw-bold letter-spacing-1">
                <i class="bi bi-star-fill me-1"></i> Most Popular
              </small>
            </div>
            {% endif %}
            
            <div class="card-body d-flex flex-column p-4">
              <!-- Product Name & Description -->
              <div class="text-center mb-4">
                <h3 class="card-title fw-bold mb-2">{{ product.name }}</h3>
                {% if product.description %}
                <p class="text-muted small">{{ product.description }}</p>
                {% endif %}
              </div>
              
              <!-- Pricing Display -->
              <div class="pricing-display text-center mb-4">
                <!-- Monthly Pricing -->
                <div class="monthly-price" data-product-id="{{ product.id }}">
                  {% if product.prices.monthly %}
                  <div class="price-amount">
                    <span class="currency">$</span>
                    <span class="h1 fw-bold">{{ product.prices.monthly.amount|floatformat:0 }}</span>
                    <span class="period text-muted">/month</span>
                  </div>
                  {% if product.prices.monthly.display_name %}
                  <small class="text-muted">{{ product.prices.monthly.display_name }}</small>
                  {% endif %}
                  {% else %}
                  <div class="text-muted">Monthly not available</div>
                  {% endif %}
                </div>
                
                <!-- Yearly Pricing (Hidden by default) -->
                <div class="yearly-price d-none" data-product-id="{{ product.id }}">
                  {% if product.prices.yearly %}
                  <div class="price-amount">
                    <span class="currency">$</span>
                    <span class="h1 fw-bold">{{ product.prices.yearly.amount|floatformat:0 }}</span>
                    <span class="period text-muted">/year</span>
                  </div>
                  {% if product.prices.yearly.display_name %}
                  <small class="text-muted">{{ product.prices.yearly.display_name }}</small>
                  {% elif product.prices.monthly %}
                  <small class="text-success">
                    <i class="bi bi-tag-fill me-1"></i>
                    Save with annual billing
                  </small>
                  {% endif %}
                  {% else %}
                  <div class="text-muted">Yearly not available</div>
                  {% endif %}
                </div>
              </div>
              
              <!-- Tokens/Usage Limit -->
              {% if product.tokens %}
              <div class="text-center mb-4">
                <div class="badge bg-gradient-cyan text-white px-3 py-2">
                  <i class="bi bi-magic me-1"></i>
                  <strong>{{ product.tokens }}</strong> transformations/month
                </div>
              </div>
              {% endif %}
              
              <!-- Features List -->
              {% if product.features_list %}
              <ul class="list-unstyled feature-list mb-4 flex-grow-1">
                {% for feature in product.features_list %}
                <li class="mb-3 d-flex align-items-start">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1 flex-shrink-0"></i>
                  <span>{{ feature }}</span>
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <!-- Default features if none specified -->
              <ul class="list-unstyled feature-list mb-4 flex-grow-1">
                <li class="mb-3 d-flex align-items-start">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1 flex-shrink-0"></i>
                  <span>AI-powered venue transformations</span>
                </li>
                <li class="mb-3 d-flex align-items-start">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1 flex-shrink-0"></i>
                  <span>Multiple wedding styles</span>
                </li>
                <li class="mb-3 d-flex align-items-start">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1 flex-shrink-0"></i>
                  <span>High-resolution downloads</span>
                </li>
              </ul>
              {% endif %}
              
              <!-- CTA Buttons -->
              <div class="mt-auto">
                {% if user_authenticated %}
                  <!-- Monthly Subscribe Button -->
                  <div class="monthly-button" data-product-id="{{ product.id }}">
                    {% if product.prices.monthly %}
                    <form method="post" action="{% url 'subscriptions:checkout' %}" class="checkout-form">
                      {% csrf_token %}
                      <input type="hidden" name="price_id" value="{{ product.prices.monthly.id }}">
                      <button type="submit" class="btn {% if product.highlight %}btn-gradient-rose{% else %}btn-outline-primary{% endif %} w-100 py-3 fw-semibold">
                        Get Started
                      </button>
                    </form>
                    {% else %}
                    <button class="btn btn-secondary w-100 py-3" disabled>
                      Not Available Monthly
                    </button>
                    {% endif %}
                  </div>
                  
                  <!-- Yearly Subscribe Button (Hidden by default) -->
                  <div class="yearly-button d-none" data-product-id="{{ product.id }}">
                    {% if product.prices.yearly %}
                    <form method="post" action="{% url 'subscriptions:checkout' %}" class="checkout-form">
                      {% csrf_token %}
                      <input type="hidden" name="price_id" value="{{ product.prices.yearly.id }}">
                      <button type="submit" class="btn {% if product.highlight %}btn-gradient-rose{% else %}btn-outline-primary{% endif %} w-100 py-3 fw-semibold">
                        Get Started - Best Value
                      </button>
                    </form>
                    {% else %}
                    <button class="btn btn-secondary w-100 py-3" disabled>
                      Not Available Yearly
                    </button>
                    {% endif %}
                  </div>
                {% else %}
                  <a href="{% url 'account_signup' %}?next={% url 'subscriptions:pricing' %}" 
                     class="btn {% if product.highlight %}btn-gradient-rose{% else %}btn-outline-primary{% endif %} w-100 py-3 fw-semibold">
                    Sign Up to Get Started
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-12">
          <div class="alert alert-info text-center">
            <i class="bi bi-info-circle me-2"></i>
            Subscription plans are not currently available as we verify & test our stripe integration.<br>Thank you for your patience!
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- Trust Badges -->
  <section class="trust-section py-5 bg-light">
    <div class="container">
      <div class="row text-center g-4">
        <div class="col-md-3 col-6">
          <div class="trust-badge">
            <i class="bi bi-shield-check fs-2 text-cyan mb-2"></i>
            <h6 class="fw-semibold">Secure Payments</h6>
            <small class="text-muted">Powered by Stripe</small>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="trust-badge">
            <i class="bi bi-arrow-repeat fs-2 text-rose mb-2"></i>
            <h6 class="fw-semibold">Public Wedding Page</h6>
            <small class="text-muted">Share important details with friends & family.</small>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="trust-badge">
            <i class="bi bi-headset fs-2 text-cyan mb-2"></i>
            <h6 class="fw-semibold">Designed by Wedding Designers</h6>
            <small class="text-muted">Get designer help and inspiration</small>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="trust-badge">
            <i class="bi bi-heart-fill fs-2 text-rose mb-2"></i>
            <h6 class="fw-semibold">Made with Love</h6>
            <small class="text-muted">For couples everywhere</small>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Stripe JS -->
<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const stripe = Stripe('{{ stripe_public_key }}');
  
  // Billing toggle functionality
  const monthlyRadio = document.getElementById('monthly');
  const yearlyRadio = document.getElementById('yearly');
  
  function togglePricing(showYearly) {
    // Toggle all pricing displays
    document.querySelectorAll('.monthly-price').forEach(el => {
      el.classList.toggle('d-none', showYearly);
    });
    document.querySelectorAll('.yearly-price').forEach(el => {
      el.classList.toggle('d-none', !showYearly);
    });
    
    // Toggle all buttons
    document.querySelectorAll('.monthly-button').forEach(el => {
      el.classList.toggle('d-none', showYearly);
    });
    document.querySelectorAll('.yearly-button').forEach(el => {
      el.classList.toggle('d-none', !showYearly);
    });
  }
  
  monthlyRadio?.addEventListener('change', () => togglePricing(false));
  yearlyRadio?.addEventListener('change', () => togglePricing(true));
  
  // FIXED: Prevent duplicate submissions with proper tracking
  let isSubmitting = false;
  
  // Handle checkout form submissions
  const checkoutForms = document.querySelectorAll('.checkout-form');
  checkoutForms.forEach(form => {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // FIXED: Prevent duplicate submissions
      if (isSubmitting) {
        console.log('Form submission already in progress, ignoring duplicate request');
        return;
      }
      
      isSubmitting = true;
      const submitButton = form.querySelector('button[type="submit"]');
      const originalText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
      
      // Add visual feedback
      form.classList.add('submitting');
      
      try {
        const formData = new FormData(form);
        
        // ADDED: Debug logging for price_id
        const priceId = formData.get('price_id');
        console.log('Submitting checkout with price_id:', priceId);
        
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          }
        });
        
        const data = await response.json();
        
        if (data.sessionId) {
          console.log('Redirecting to Stripe checkout with session:', data.sessionId);
          // Redirect to Stripe Checkout
          const result = await stripe.redirectToCheckout({
            sessionId: data.sessionId
          });
          
          if (result.error) {
            console.error('Stripe redirect error:', result.error);
            alert(result.error.message);
            resetFormState();
          }
          // If successful, user will be redirected away, no need to reset
        } else if (data.error) {
          console.error('Checkout creation error:', data.error);
          alert('Error: ' + data.error);
          resetFormState();
        } else {
          console.error('Unexpected response format:', data);
          alert('Unexpected response from server. Please try again.');
          resetFormState();
        }
      } catch (error) {
        console.error('Network/fetch error:', error);
        alert('Network error occurred. Please check your connection and try again.');
        resetFormState();
      }
      
      function resetFormState() {
        isSubmitting = false;
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
        form.classList.remove('submitting');
      }
    });
  });

  // REMOVED: Problematic auto-checkout logic that caused race conditions
  // Old problematic code:
  // {% if is_new_user and auto_checkout_price_id %}
  // setTimeout(function() {
  //   const form = document.querySelector(`form input[value="{{ auto_checkout_price_id }}"]`);
  //   if (form) {
  //     form.closest('form').submit();
  //   }
  // }, 500);
  // {% endif %}
  
  // ADDED: Debug logging for context
  {% if auto_checkout_price_id %}
  console.log('Auto-checkout price ID available (but auto-submit disabled):', '{{ auto_checkout_price_id }}');
  {% endif %}
  
  {% if is_new_user %}
  console.log('New user detected - simplified behavior (no session dependency)');
  {% endif %}
  
  // Log navigation source for debugging
  const urlParams = new URLSearchParams(window.location.search);
  const source = urlParams.get('source') || 'direct';
  console.log('Navigation source:', source);
});
</script>

<style>
.pricing-card {
  border: none;
  border-radius: 12px;
  transition: all 0.3s ease;
  overflow: hidden;
}

.pricing-card:hover {
  transform: translateY(-10px);
  box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
}

.featured-card {
  border: 2px solid var(--bs-primary);
  position: relative;
}

.featured-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--bs-cyan), var(--bs-primary), var(--bs-rose));
}

.price-amount {
  display: flex;
  align-items: baseline;
  justify-content: center;
  gap: 4px;
}

.currency {
  font-size: 1.5rem;
  font-weight: 500;
  opacity: 0.7;
}

.period {
  font-size: 1rem;
  margin-left: 4px;
}

.feature-list li {
  font-size: 0.95rem;
}

.billing-toggle .btn-check:checked + .btn {
  background: var(--bs-primary);
  color: white;
}

.trust-badge {
  padding: 1rem;
  transition: transform 0.2s;
}

.trust-badge:hover {
  transform: scale(1.05);
}

.letter-spacing-1 {
  letter-spacing: 0.1em;
}

.bg-gradient-to-b {
  background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
}

/* ADDED: Visual feedback for form submission states */
.checkout-form.submitting {
  opacity: 0.7;
  pointer-events: none;
}

.checkout-form button[disabled] {
  pointer-events: none;
}

/* ADDED: Better visual feedback for disabled state */
.checkout-form.submitting .card {
  position: relative;
}

.checkout-form.submitting .card::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  border-radius: inherit;
  z-index: 1;
}
</style>
{% endblock %}