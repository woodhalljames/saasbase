{% extends "base.html" %}
{% load static %}

{% block title %}Pricing - DreamWedAI{% endblock %}

{% block content %}
<div class="pricing-page">
  <!-- Hero Section -->
  <section class="pricing-hero py-5 bg-gradient-to-b from-white to-light">
    <div class="container">
      <div class="row justify-content-center text-center">
        <div class="col-lg-8">
          <h1 class="display-4 fw-bold mb-3">
            Choose Your Perfect Plan
          </h1>
          <p class="lead text-muted mb-4">
           Get the tools needed for the perfect wedding.
          </p>
          
          <!-- Billing Toggle with Rose Styling -->
          <div class="billing-toggle mb-5">
            <div class="btn-group" role="group" aria-label="Billing period">
              <input type="radio" class="btn-check" name="billing" id="monthly" checked>
              <label class="btn btn-outline-rose" for="monthly">Monthly Billing</label>
              
              <input type="radio" class="btn-check" name="billing" id="yearly">
              <label class="btn btn-outline-rose" for="yearly">Yearly Billing <span class="badge bg-success ms-2">6 Months Free</span></label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Error Handling -->
  {% if error %}
  <div class="container">
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      {{ error }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  </div>
  {% endif %}

  <!-- Pricing Cards -->
  <section class="pricing-cards py-5">
    <div class="container">
      <div class="row g-4 align-items-stretch">
        {% for product in products %}
        <div class="col-lg-4 col-md-6">
          <div class="card h-100 pricing-card {% if product.highlight %}featured-card shadow-lg{% else %}shadow{% endif %}">
            {% if product.highlight %}
            <div class="card-header bg-gradient-rose text-white text-center py-2">
              <small class="text-uppercase fw-bold letter-spacing-1">
                <i class="bi bi-star-fill me-1"></i> Most Popular
              </small>
            </div>
            {% endif %}
            
            <div class="card-body d-flex flex-column p-4">
              <!-- Product Name & Description -->
              <div class="text-center mb-4">
                <h3 class="card-title fw-bold mb-2">{{ product.name }}</h3>
                {% if product.description %}
                <p class="text-muted small">{{ product.description }}</p>
                {% endif %}
              </div>
              
              <!-- Pricing Display -->
              <div class="pricing-display text-center mb-4">
                <!-- Monthly Pricing -->
                <div class="monthly-price" data-product-id="{{ product.id }}">
                  {% if product.prices.monthly %}
                  <div class="price-amount">
                    <span class="currency">$</span>
                    <span class="h1 fw-bold">{{ product.prices.monthly.amount|floatformat:0 }}</span>
                    <span class="period text-muted">/month</span>
                  </div>
                  <small class="text-muted d-block">Taxes included</small>
                  {% if product.prices.monthly.display_name %}
                  <small class="text-muted">{{ product.prices.monthly.display_name }}</small>
                  {% endif %}
                  {% else %}
                  <div class="text-muted">Monthly not available</div>
                  {% endif %}
                </div>
                
                <!-- Yearly Pricing (Hidden by default) -->
                <div class="yearly-price d-none" data-product-id="{{ product.id }}">
                  {% if product.prices.yearly %}
                  <div class="price-amount">
                    <span class="currency">$</span>
                    <span class="h1 fw-bold">{{ product.prices.yearly.amount|floatformat:0 }}</span>
                    <span class="period text-muted">/year</span>
                  </div>
                  <small class="text-muted d-block">Taxes included</small>
                  {% if product.prices.yearly.display_name %}
                  <small class="text-muted">{{ product.prices.yearly.display_name }}</small>
                  {% elif product.prices.monthly %}
                 
                  {% endif %}
                  {% else %}
                  <div class="text-muted">Yearly not available</div>
                  {% endif %}
                </div>
              </div>
              
              
              <!-- Features List -->
              {% if product.features_list %}
              <ul class="list-unstyled feature-list mb-4 flex-grow-1">
                {% for feature in product.features_list %}
                <li class="mb-3 d-flex align-items-start">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1 flex-shrink-0"></i>
                  <span>{{ feature }}</span>
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <!-- Default features if none specified -->
              <ul class="list-unstyled feature-list mb-4 flex-grow-1">
                <li class="mb-3 d-flex align-items-start">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1 flex-shrink-0"></i>
                  <span>AI-powered venue transformations</span>
                </li>
                <li class="mb-3 d-flex align-items-start">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1 flex-shrink-0"></i>
                  <span>Multiple wedding styles</span>
                </li>
                <li class="mb-3 d-flex align-items-start">
                  <i class="bi bi-check-circle-fill text-success me-2 mt-1 flex-shrink-0"></i>
                  <span>High-resolution downloads</span>
                </li>
              </ul>
              {% endif %}
              
              <!-- CTA Buttons -->
              <div class="mt-auto">
                {% if user_authenticated %}
                  <!-- Monthly Subscribe Button -->
                  <div class="monthly-button" data-product-id="{{ product.id }}">
                    {% if product.prices.monthly %}
                    <form method="post" action="{% url 'subscriptions:checkout' %}" class="checkout-form">
                      {% csrf_token %}
                      <input type="hidden" name="price_id" value="{{ product.prices.monthly.id }}">
                      <button type="submit" class="btn {% if product.highlight %}btn-gradient-rose{% else %}btn-outline-primary{% endif %} w-100 py-3 fw-semibold">
                        Get Started
                      </button>
                    </form>
                    {% else %}
                    <button class="btn btn-secondary w-100 py-3" disabled>
                      Not Available Monthly
                    </button>
                    {% endif %}
                  </div>
                  
                  <!-- Yearly Subscribe Button (Hidden by default) -->
                  <div class="yearly-button d-none" data-product-id="{{ product.id }}">
                    {% if product.prices.yearly %}
                    <form method="post" action="{% url 'subscriptions:checkout' %}" class="checkout-form">
                      {% csrf_token %}
                      <input type="hidden" name="price_id" value="{{ product.prices.yearly.id }}">
                      <button type="submit" class="btn {% if product.highlight %}btn-gradient-rose{% else %}btn-outline-primary{% endif %} w-100 py-3 fw-semibold">
                        Get Started - Best Value
                      </button>
                    </form>
                    {% else %}
                    <button class="btn btn-secondary w-100 py-3" disabled>
                      Not Available Yearly
                    </button>
                    {% endif %}
                  </div>
                {% else %}
                  <a href="{% url 'account_signup' %}?next={% url 'subscriptions:pricing' %}" 
                     class="btn {% if product.highlight %}btn-gradient-rose{% else %}btn-outline-primary{% endif %} w-100 py-3 fw-semibold">
                    Sign Up to Get Started
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-12">
          <div class="alert alert-info text-center">
            <i class="bi bi-info-circle me-2"></i>
            Subscription plans are not currently available as we verify & test our stripe integration.<br>Thank you for your patience!
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- Trust Badges -->
  <section class="trust-section py-5 bg-light">
    <div class="container">
      <div class="row text-center g-4">
        <div class="col-md-3 col-6">
          <div class="trust-badge">
            <i class="bi bi-shield-check fs-2 text-cyan mb-2"></i>
            <h6 class="fw-semibold">Secure Payments</h6>
            <small class="text-muted">Powered by Stripe</small>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="trust-badge">
            <i class="bi bi-lightning fs-2 text-rose mb-2"></i>
            <h6 class="fw-semibold">Smart Visualization</h6>
            <small class="text-muted">Up to date with the best AI technology for stunning results</small>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="trust-badge">
            <i class="bi bi-heart-fill fs-2 text-cyan mb-2"></i>
           <h6 class="fw-semibold">Professional Wedding Design</h6>
            <small class="text-muted">Wedding designer inspiration & styling</small>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="trust-badge">
            <i class="bi bi-clipboard-check fs-2 text-rose mb-2"></i>
            <h6 class="fw-semibold">Built for Wedding Pros</h6>
            <small class="text-muted">Impress with powerful visualization, sharing & organization tools</small>
          </div>
        </div>
      </div>
    </div>
  </section>


  <!-- FAQ Section -->
  <section class="faq-section py-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <!-- Section Header -->
          <div class="text-center mb-5">
            <h2 class="section-title">Frequently Asked Questions</h2>
            <p class="section-subtitle">
              Everything you need to know about our plans and policies
            </p>
          </div>

          <!-- FAQ Accordion -->
          <div class="accordion" id="pricingFAQ">
            
            <!-- FAQ Item 1: Cancellation Policy -->
            <div class="accordion-item">
              <h3 class="accordion-header" id="faq-cancellation">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#collapse-cancellation" aria-expanded="false" 
                        aria-controls="collapse-cancellation">
                  Can I cancel my subscription anytime?
                </button>
              </h3>
              <div id="collapse-cancellation" class="accordion-collapse collapse" 
                   aria-labelledby="faq-cancellation" data-bs-parent="#pricingFAQ">
                <div class="accordion-body">
                  <p><strong>Yes, you can cancel anytime with no questions asked.</strong> We believe in complete flexibility for our users.</p>
                  
                  <p>When you cancel:</p>
                  <ul>
                    <li>Cancel instantly from your account dashboard</li>
                    <li><strong>Keep all your remaining transformations</strong> - they don't expire when you cancel</li>
                    <li>Continue using any unused tokens until they're gone</li>
                    <li>Reactivate anytime to get fresh monthly tokens</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- FAQ Item 2: Free Wedding Page -->
            <div class="accordion-item">
              <h3 class="accordion-header" id="faq-wedding-page">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#collapse-wedding-page" aria-expanded="false" 
                        aria-controls="collapse-wedding-page">
                  Do I need a subscription for a wedding page?
                </button>
              </h3>
              <div id="collapse-wedding-page" class="accordion-collapse collapse" 
                   aria-labelledby="faq-wedding-page" data-bs-parent="#pricingFAQ">
                <div class="accordion-body">
                  <p><strong>No subscription required!</strong> Your beautiful wedding page is completely free to create, customize, and maintain forever.</p>
                  
                  <p><strong>Free Forever:</strong> Custom wedding website, RSVP management, photo sharing, link management, and more.</p>
                  
                  <p><strong>Subscription Adds:</strong> AI venue transformations, professional designer styling tools, access wedding designer support.</p>
                </div>
              </div>
            </div>

            <!-- FAQ Item 3: Refund Policy -->
            <div class="accordion-item">
              <h3 class="accordion-header" id="faq-refunds">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#collapse-refunds" aria-expanded="false" 
                        aria-controls="collapse-refunds">
                  What's your refund policy?
                </button>
              </h3>
              <div id="collapse-refunds" class="accordion-collapse collapse" 
                   aria-labelledby="faq-refunds" data-bs-parent="#pricingFAQ">
                <div class="accordion-body">
                  <p>Due to the immediate costs of AI processing and cloud computing resources, we operate on a <strong>no-refund policy</strong>.</p>
                  
                  <p><strong>Why no refunds?</strong> Every transformation uses expensive GPU compute time and advanced AI models. Your tokens are converted to images immediately upon use, creating real costs that can't be reversed.</p>
                  
                  <p><strong>Fair Alternative:</strong> Since we can't offer refunds, we let you cancel anytime and keep all unused transformations. Plus, try our service risk-free with a free trial!</p>
                </div>
              </div>
            </div>

            <!-- FAQ Item 4: How Billing Works -->
            <div class="accordion-item">
              <h3 class="accordion-header" id="faq-billing">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#collapse-billing" aria-expanded="false" 
                        aria-controls="collapse-billing">
                  How does billing work?
                </button>
              </h3>
              <div id="collapse-billing" class="accordion-collapse collapse" 
                   aria-labelledby="faq-billing" data-bs-parent="#pricingFAQ">
                <div class="accordion-body">
                  <p><strong>Monthly Plans:</strong> Charged every month on your signup date. Fresh transformations added monthly. Cancel anytime before next billing.</p>
                  
                  <p><strong>Annual Plans:</strong> Charged once per year. Transformations reset each month for a year. Cancel anytime before next annual bill.</p>
                  
                  <p>All billing is secure and processed by Stripe. We never store your payment information.</p>
                </div>
              </div>
            </div>

            <!-- FAQ Item 5: Token Usage -->
            <div class="accordion-item">
              <h3 class="accordion-header" id="faq-tokens">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#collapse-tokens" aria-expanded="false" 
                        aria-controls="collapse-tokens">
                  How do transformation tokens work?
                </button>
              </h3>
              <div id="collapse-tokens" class="accordion-collapse collapse" 
                   aria-labelledby="faq-tokens" data-bs-parent="#pricingFAQ">
                <div class="accordion-body">
                  <p>Think of tokens like credits for prompt transformations. Each token = one venue transformation.</p>
                  
                  <p><strong>How it works:</strong> Upload your venue photo, choose several styles (garden theme, reception, morning, etc.), and transform. Each transformation uses 1 token.</p>
                  
                  <p><strong>Important:</strong></p>
                  <ul>
                    <li>Tokens never expire, even after cancellation</li>
                    <li>Failed transformations don't use tokens</li>
                    <li>You can download and save all your transformed images</li>
                    <li>Active subscribers get fresh tokens each billing cycle</li>
                  </ul>
                </div>
              </div>
            </div>

          </div>

          <!-- CTA After FAQ -->
          <div class="text-center mt-5">
            <p class="text-muted mb-3">Still have questions?</p>
            <a href="mailto:hello@dreamwedai.com" class="btn btn-outline-primary">Contact Support</a>
          </div>

        </div>
      </div>
    </div>
  </section>




</div>

<!-- Stripe JS -->
<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const stripe = Stripe('{{ stripe_public_key }}');
  
  // Billing toggle functionality
  const monthlyRadio = document.getElementById('monthly');
  const yearlyRadio = document.getElementById('yearly');
  
  function togglePricing(showYearly) {
    // Toggle all pricing displays
    document.querySelectorAll('.monthly-price').forEach(el => {
      el.classList.toggle('d-none', showYearly);
    });
    document.querySelectorAll('.yearly-price').forEach(el => {
      el.classList.toggle('d-none', !showYearly);
    });
    
    // Toggle all buttons
    document.querySelectorAll('.monthly-button').forEach(el => {
      el.classList.toggle('d-none', showYearly);
    });
    document.querySelectorAll('.yearly-button').forEach(el => {
      el.classList.toggle('d-none', !showYearly);
    });
  }
  
  monthlyRadio?.addEventListener('change', () => togglePricing(false));
  yearlyRadio?.addEventListener('change', () => togglePricing(true));
  
  // FIXED: Prevent duplicate submissions with proper tracking
  let isSubmitting = false;
  
  // Handle checkout form submissions
  const checkoutForms = document.querySelectorAll('.checkout-form');
  checkoutForms.forEach(form => {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // FIXED: Prevent duplicate submissions
      if (isSubmitting) {
        console.log('Form submission already in progress, ignoring duplicate request');
        return;
      }
      
      isSubmitting = true;
      const submitButton = form.querySelector('button[type="submit"]');
      const originalText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
      
      // Add visual feedback
      form.classList.add('submitting');
      
      try {
        const formData = new FormData(form);
        
        // ADDED: Debug logging for price_id
        const priceId = formData.get('price_id');
        console.log('Submitting checkout with price_id:', priceId);
        
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          }
        });
        
        const data = await response.json();
        
        if (data.sessionId) {
          console.log('Redirecting to Stripe checkout with session:', data.sessionId);
          // Redirect to Stripe Checkout
          const result = await stripe.redirectToCheckout({
            sessionId: data.sessionId
          });
          
          if (result.error) {
            console.error('Stripe redirect error:', result.error);
            alert(result.error.message);
            resetFormState();
          }
          // If successful, user will be redirected away, no need to reset
        } else if (data.error) {
          console.error('Checkout creation error:', data.error);
          alert('Error: ' + data.error);
          resetFormState();
        } else {
          console.error('Unexpected response format:', data);
          alert('Unexpected response from server. Please try again.');
          resetFormState();
        }
      } catch (error) {
        console.error('Network/fetch error:', error);
        alert('Network error occurred. Please check your connection and try again.');
        resetFormState();
      }
      
      function resetFormState() {
        isSubmitting = false;
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
        form.classList.remove('submitting');
      }
    });
  });


  
  // ADDED: Debug logging for context
  {% if auto_checkout_price_id %}
  console.log('Auto-checkout price ID available (but auto-submit disabled):', '{{ auto_checkout_price_id }}');
  {% endif %}
  
  {% if is_new_user %}
  console.log('New user detected - simplified behavior (no session dependency)');
  {% endif %}
  
  // Log navigation source for debugging
  const urlParams = new URLSearchParams(window.location.search);
  const source = urlParams.get('source') || 'direct';
  console.log('Navigation source:', source);
});
</script>

<style>
.pricing-card {
  border: none;
  border-radius: 12px;
  transition: all 0.3s ease;
  overflow: hidden;
}

.pricing-card:hover {
  transform: translateY(-10px);
  box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
}

.featured-card {
  border: 2px solid var(--bs-primary);
  position: relative;
}

.featured-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--bs-cyan), var(--bs-primary), var(--bs-rose));
}

.price-amount {
  display: flex;
  align-items: baseline;
  justify-content: center;
  gap: 4px;
}

.currency {
  font-size: 1.5rem;
  font-weight: 500;
  opacity: 0.7;
}

.period {
  font-size: 1rem;
  margin-left: 4px;
}

.feature-list li {
  font-size: 0.95rem;
}

/* Updated Billing Toggle to Use Rose */
.billing-toggle .btn-check:checked + .btn-outline-rose {
  background: var(--electric-rose);
  border-color: var(--electric-rose);
  color: white;
}

.btn-outline-rose {
  border-color: var(--electric-rose);
  color: var(--electric-rose);
  font-weight: 600;
  border-radius: 25px;
  transition: all 0.3s ease;
}

.btn-outline-rose:hover {
  background: var(--electric-rose);
  border-color: var(--electric-rose);
  color: white;
  transform: translateY(-2px);
}

.trust-badge {
  padding: 1rem;
  transition: transform 0.2s;
}

.trust-badge:hover {
  transform: scale(1.05);
}

.letter-spacing-1 {
  letter-spacing: 0.1em;
}

.bg-gradient-to-b {
  background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
}

/* ADDED: Visual feedback for form submission states */
.checkout-form.submitting {
  opacity: 0.7;
  pointer-events: none;
}

.checkout-form button[disabled] {
  pointer-events: none;
}

/* ADDED: Better visual feedback for disabled state */
.checkout-form.submitting .card {
  position: relative;
}

.checkout-form.submitting .card::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  border-radius: inherit;
  z-index: 1;
}
</style>
{% endblock %}