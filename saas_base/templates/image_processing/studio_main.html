{% extends "base.html" %}
{% load static %}

{% block title %}Studio - Upload & Process{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h1 class="display-5">AI Image Studio</h1>
      <p class="lead">Upload images and transform them with AI-powered prompts</p>
    </div>
  </div>

  <!-- Upload Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-primary">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-cloud-upload"></i> Upload Image</h5>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}
            
            <!-- Single Upload Area -->
            <div class="upload-area border-2 border-dashed rounded p-4 text-center" 
                 style="border-color: #dee2e6; min-height: 150px; cursor: pointer;"
                 onclick="document.getElementById('fileInput').click()">
              <div id="uploadContent">
                <i class="bi bi-cloud-upload text-primary" style="font-size: 2.5rem;"></i>
                <h6 class="mt-2">Drop image here or click to browse</h6>
                <small class="text-muted">JPG, PNG, GIF, WebP â€¢ Max 5MB</small>
              </div>
              <div id="uploadPreview" style="display: none;">
                <div class="position-relative d-inline-block">
                  <img id="uploadImagePreview" class="img-fluid rounded" style="max-height: 200px;" alt="Preview">
                  <button type="button" class="btn btn-danger btn-sm position-absolute top-0 start-0" 
                          id="removeUploadBtn" style="margin: 5px;">
                    <i class="bi bi-x"></i>
                  </button>
                </div>
                <div class="mt-2">
                  <span id="uploadFileName" class="fw-bold"></span><br>
                  <small id="uploadFileSize" class="text-muted"></small>
                </div>
              </div>
            </div>
            <input type="file" id="fileInput" name="image" class="d-none" accept="image/*">

            <!-- Submit Button -->
            <div class="d-grid mt-3">
              <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
                <i class="bi bi-upload"></i> Upload & Add to Processing
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected Images for Processing -->
  <div class="row mb-4" id="selectedImagesSection" style="display: none;">
    <div class="col-12">
      <div class="card border-success">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-check-circle text-success"></i> 
            Selected for Processing 
            <span class="badge bg-success" id="selectedCount">0</span>
          </h5>
        </div>
        <div class="card-body">
          <!-- Selected Images Thumbnails -->
          <div id="selectedImagesList" class="d-flex gap-3 overflow-auto pb-2" style="min-height: 100px;">
            <!-- Thumbnails will be added here dynamically -->
          </div>
          
          <!-- Large Preview of Active Image -->
          <div id="activeImagePreview" class="mt-3" style="display: none;">
            <div class="row">
              <div class="col-md-8">
                <div class="text-center">
                  <img id="activeImage" class="img-fluid rounded border" style="max-height: 400px;" alt="Active Image">
                </div>
              </div>
              <div class="col-md-4">
                <h6>Image Details</h6>
                <p class="mb-1"><strong>File:</strong> <span id="activeImageName"></span></p>
                <p class="mb-1"><strong>Size:</strong> <span id="activeImageSize"></span></p>
                <p class="mb-1"><strong>Dimensions:</strong> <span id="activeImageDimensions"></span></p>
                <button type="button" class="btn btn-outline-danger btn-sm mt-2" id="removeActiveBtn">
                  <i class="bi bi-trash"></i> Remove from Processing
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Prompts Section -->
  <div class="row mb-4" id="promptsSection">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-magic"></i> Choose AI Processing Style</h5>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <strong>Your Tier:</strong> You can select up to <strong>{{ max_prompts }}</strong> prompt{{ max_prompts|pluralize }} per image.
            {% if max_prompts < 5 %}
              <a href="{% url 'subscriptions:pricing' %}" class="alert-link">Upgrade for more prompts</a>
            {% endif %}
          </div>

          <!-- Prompt Categories -->
          <div class="row">
            {% for category, category_prompts in prompts_by_category.items %}
              <div class="col-md-6 col-lg-4 mb-4">
                <h6 class="text-muted border-bottom pb-2">{{ category }}</h6>
                {% for prompt in category_prompts %}
                  <div class="form-check mb-2">
                    <input class="form-check-input prompt-checkbox" 
                           type="checkbox" 
                           value="{{ prompt.id }}" 
                           id="prompt{{ prompt.id }}">
                    <label class="form-check-label" for="prompt{{ prompt.id }}">
                      <strong>{{ prompt.name }}</strong>
                      <small class="text-muted d-block">{{ prompt.description|truncatewords:10 }}</small>
                    </label>
                  </div>
                {% endfor %}
              </div>
            {% endfor %}
          </div>

          <div class="mt-3 d-flex justify-content-between align-items-center">
            <small class="form-text text-muted">
              Selected Prompts: <span id="selectedPromptCount">0</span> / {{ max_prompts }}
            </small>
            
            <!-- Process Button -->
            <div>
              <button type="button" class="btn btn-success btn-lg" id="processImagesBtn" disabled>
                <i class="bi bi-magic"></i> Process Selected Images
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Images Gallery -->
  {% if recent_images %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-images"></i> Your Recent Images</h5>
          <div>
            <small class="text-muted me-3">Click to add to processing</small>
            <a href="{% url 'image_processing:image_gallery' %}" class="btn btn-sm btn-outline-primary">View All</a>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            {% for image in recent_images %}
              <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-3">
                <div class="card recent-image-card h-100" 
                     data-image-id="{{ image.id }}"
                     data-image-url="{% if image.thumbnail %}{{ image.thumbnail.url }}{% else %}{{ image.image.url }}{% endif %}"
                     data-image-name="{{ image.original_filename }}"
                     data-image-size="{{ image.file_size }}"
                     data-image-dimensions="{{ image.width }}x{{ image.height }}"
                     style="cursor: pointer; transition: all 0.2s;">
                  <div class="position-relative">
                    <img src="{% if image.thumbnail %}{{ image.thumbnail.url }}{% else %}{{ image.image.url }}{% endif %}" 
                         class="card-img-top" 
                         alt="{{ image.original_filename }}"
                         style="height: 120px; object-fit: cover;">
                    
                    <!-- Added indicator -->
                    <div class="position-absolute top-0 end-0 p-1 added-indicator" style="display: none;">
                      <span class="badge bg-success">
                        <i class="bi bi-check"></i>
                      </span>
                    </div>
                  </div>
                  
                  <div class="card-body p-2">
                    <small class="text-muted d-block text-truncate" title="{{ image.original_filename }}">
                      {{ image.original_filename }}
                    </small>
                    <small class="text-muted">{{ image.uploaded_at|timesince }} ago</small>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% else %}
    <!-- Empty State -->
    <div class="row">
      <div class="col-12">
        <div class="text-center py-5">
          <i class="bi bi-images text-muted" style="font-size: 4rem;"></i>
          <h3 class="mt-3 text-muted">No Images Yet</h3>
          <p class="text-muted">Upload your first image above to get started with AI processing</p>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Recent Processing Jobs -->
  {% if recent_jobs %}
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Processing</h5>
          <a href="{% url 'image_processing:processing_history' %}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body">
          <div class="list-group list-group-flush">
            {% for job in recent_jobs %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ job.user_image.original_filename }}</strong>
                  <small class="text-muted d-block">{{ job.prompt_count }} prompt{{ job.prompt_count|pluralize }}</small>
                </div>
                <div class="text-end">
                  <span class="badge {% if job.status == 'completed' %}bg-success{% elif job.status == 'failed' %}bg-danger{% elif job.status == 'processing' %}bg-warning{% else %}bg-secondary{% endif %}">
                    {{ job.get_status_display }}
                  </span>
                  <small class="text-muted d-block">{{ job.created_at|timesince }} ago</small>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // State management
    let selectedImages = [];
    let activeImageId = null;
    
    // Elements
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadContent = document.getElementById('uploadContent');
    const uploadPreview = document.getElementById('uploadPreview');
    const removeUploadBtn = document.getElementById('removeUploadBtn');
    const selectedImagesSection = document.getElementById('selectedImagesSection');
    const selectedImagesList = document.getElementById('selectedImagesList');
    const selectedCountBadge = document.getElementById('selectedCount');
    const activeImagePreview = document.getElementById('activeImagePreview');
    const processImagesBtn = document.getElementById('processImagesBtn');
    const promptCheckboxes = document.querySelectorAll('.prompt-checkbox');
    const selectedPromptCount = document.getElementById('selectedPromptCount');
    const maxPrompts = {{ max_prompts }};

    // Upload functionality
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            handleFileUpload(file);
        }
    });

    // Drag and drop
    const uploadArea = document.querySelector('.upload-area');
    setupDragDrop(uploadArea);

    // Remove uploaded image
    removeUploadBtn.addEventListener('click', function() {
        resetUploadArea();
    });

    // Recent images click to add
    document.querySelectorAll('.recent-image-card').forEach(card => {
        card.addEventListener('click', function() {
            const imageData = {
                id: this.dataset.imageId,
                url: this.dataset.imageUrl,
                name: this.dataset.imageName,
                size: this.dataset.imageSize,
                dimensions: this.dataset.imageDimensions
            };
            addImageToSelection(imageData);
            
            // Show visual feedback
            const indicator = this.querySelector('.added-indicator');
            indicator.style.display = 'block';
            this.style.opacity = '0.7';
            this.style.pointerEvents = 'none';
        });
    });

    // Prompt selection
    promptCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updatePromptSelection);
    });

    // Process images button
    processImagesBtn.addEventListener('click', function() {
        processSelectedImages();
    });

    function handleFileUpload(file) {
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('uploadImagePreview').src = e.target.result;
            document.getElementById('uploadFileName').textContent = file.name;
            document.getElementById('uploadFileSize').textContent = formatFileSize(file.size);
            
            uploadContent.style.display = 'none';
            uploadPreview.style.display = 'block';
            uploadBtn.disabled = false;
        };
        reader.readAsDataURL(file);
    }

    function resetUploadArea() {
        fileInput.value = '';
        uploadContent.style.display = 'block';
        uploadPreview.style.display = 'none';
        uploadBtn.disabled = true;
    }

    function setupDragDrop(element) {
        element.addEventListener('dragover', function(e) {
            e.preventDefault();
            element.style.backgroundColor = '#f8f9fa';
        });

        element.addEventListener('dragleave', function(e) {
            e.preventDefault();
            element.style.backgroundColor = 'transparent';
        });

        element.addEventListener('drop', function(e) {
            e.preventDefault();
            element.style.backgroundColor = 'transparent';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileUpload(files[0]);
            }
        });
    }

    function addImageToSelection(imageData) {
        // Check if already selected
        if (selectedImages.find(img => img.id === imageData.id)) {
            return;
        }

        selectedImages.push(imageData);
        updateSelectedImagesDisplay();
        updateProcessButton();
    }

    function removeImageFromSelection(imageId) {
        selectedImages = selectedImages.filter(img => img.id !== imageId);
        
        // Reset active image if it was removed
        if (activeImageId === imageId) {
            activeImageId = null;
            activeImagePreview.style.display = 'none';
        }
        
        updateSelectedImagesDisplay();
        updateProcessButton();
        
        // Re-enable recent image if it was from there
        const recentCard = document.querySelector(`[data-image-id="${imageId}"]`);
        if (recentCard) {
            recentCard.style.opacity = '1';
            recentCard.style.pointerEvents = 'auto';
            recentCard.querySelector('.added-indicator').style.display = 'none';
        }
    }

    function updateSelectedImagesDisplay() {
        selectedCountBadge.textContent = selectedImages.length;
        
        if (selectedImages.length === 0) {
            selectedImagesSection.style.display = 'none';
            return;
        }

        selectedImagesSection.style.display = 'block';
        
        // Update thumbnails
        selectedImagesList.innerHTML = '';
        selectedImages.forEach(image => {
            const thumbnail = createImageThumbnail(image);
            selectedImagesList.appendChild(thumbnail);
        });
    }

    function createImageThumbnail(imageData) {
        const div = document.createElement('div');
        div.className = 'position-relative';
        div.style.minWidth = '100px';
        
        div.innerHTML = `
            <div class="card selected-image-thumb ${activeImageId === imageData.id ? 'border-primary' : ''}" 
                 style="width: 100px; cursor: pointer;" 
                 data-image-id="${imageData.id}">
                <img src="${imageData.url}" 
                     class="card-img-top" 
                     style="height: 80px; object-fit: cover;" 
                     alt="${imageData.name}">
                <button type="button" 
                        class="btn btn-danger btn-sm position-absolute top-0 end-0" 
                        style="margin: 2px; padding: 2px 6px;"
                        onclick="removeImageFromSelection('${imageData.id}')">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;
        
        // Click to view large preview
        div.querySelector('.selected-image-thumb').addEventListener('click', function() {
            showActiveImagePreview(imageData);
        });
        
        return div;
    }

    function showActiveImagePreview(imageData) {
        activeImageId = imageData.id;
        
        // Update active image display
        document.getElementById('activeImage').src = imageData.url;
        document.getElementById('activeImageName').textContent = imageData.name;
        document.getElementById('activeImageSize').textContent = formatFileSize(parseInt(imageData.size));
        document.getElementById('activeImageDimensions').textContent = imageData.dimensions;
        
        // Show preview
        activeImagePreview.style.display = 'block';
        
        // Update thumbnail borders
        document.querySelectorAll('.selected-image-thumb').forEach(thumb => {
            thumb.classList.remove('border-primary');
        });
        document.querySelector(`[data-image-id="${imageData.id}"]`).classList.add('border-primary');
        
        // Setup remove button
        document.getElementById('removeActiveBtn').onclick = function() {
            removeImageFromSelection(imageData.id);
        };
    }

    function updatePromptSelection() {
        const selected = document.querySelectorAll('.prompt-checkbox:checked');
        selectedPromptCount.textContent = selected.length;
        
        if (selected.length > maxPrompts) {
            selected[selected.length - 1].checked = false;
            selectedPromptCount.textContent = maxPrompts;
        }
        
        // Disable other checkboxes if at limit
        promptCheckboxes.forEach(checkbox => {
            if (!checkbox.checked && document.querySelectorAll('.prompt-checkbox:checked').length >= maxPrompts) {
                checkbox.disabled = true;
            } else {
                checkbox.disabled = false;
            }
        });
        
        updateProcessButton();
    }

    function updateProcessButton() {
        const hasImages = selectedImages.length > 0;
        const hasPrompts = document.querySelectorAll('.prompt-checkbox:checked').length > 0;
        
        processImagesBtn.disabled = !hasImages || !hasPrompts;
        
        if (hasImages) {
            processImagesBtn.innerHTML = `<i class="bi bi-magic"></i> Process ${selectedImages.length} Image${selectedImages.length !== 1 ? 's' : ''}`;
        } else {
            processImagesBtn.innerHTML = '<i class="bi bi-magic"></i> Process Selected Images';
        }
    }

    function processSelectedImages() {
        const selectedPrompts = Array.from(document.querySelectorAll('.prompt-checkbox:checked')).map(cb => cb.value);
        
        if (selectedImages.length === 0 || selectedPrompts.length === 0) {
            alert('Please select at least one image and one prompt');
            return;
        }

        // For MVP, process first image (in production, you'd batch process)
        const firstImageId = selectedImages[0].id;
        
        // For now, redirect to individual processing page
        // In the future, you could implement batch processing here
        window.location.href = `/studio/image/${firstImageId}/`;
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Make functions global for onclick handlers
    window.removeImageFromSelection = removeImageFromSelection;
});
</script>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
{% endblock %}