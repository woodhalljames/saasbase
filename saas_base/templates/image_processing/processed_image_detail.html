{% extends "base.html" %}
{% load static %}

{% block title %}Wedding Transformation Details{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container py-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'image_processing:wedding_studio' %}">Wedding Studio</a></li>
      <li class="breadcrumb-item"><a href="{% url 'image_processing:processing_history' %}">Processing History</a></li>
      <li class="breadcrumb-item active">Transformation Details</li>
    </ol>
  </nav>

  <!-- Unified Card Layout -->
  <div class="row justify-content-center">
    <div class="col-xl-10">
      <div class="card shadow-lg border-0">
        
        <!-- Card Header with Title and Status -->
        <div class="card-header bg-gradient-primary text-white py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-1">
                <i class="bi bi-magic me-2"></i>
                {{ theme_display }} • {{ space_display }}
              </h4>
              <small class="opacity-75">
                <i class="bi bi-calendar me-1"></i>
                Created {{ processed_image.created_at|date:"M d, Y" }} at {{ processed_image.created_at|time:"g:i A" }}
              </small>
            </div>
            <div class="d-flex align-items-center gap-2">
              <!-- Favorite Heart -->
              {% include 'image_processing/components/favorite_heart.html' with processed_image=processed_image %}
              
              <!-- Saved Badge -->
             
            </div>
          </div>
        </div>

        <div class="card-body p-0">
          
          <!-- Main Image Section -->
          <div class="border-bottom">
            <div class="p-4 text-center">
              <img src="{{ processed_image.processed_image.url }}" 
                   class="img-fluid rounded shadow-sm" 
                   alt="Wedding Transformation"
                   style="max-height: 600px; width: 100%; object-fit: contain;">
              
              <!-- Image Stats Row -->
              <div class="row text-center mt-3 py-2 bg-light rounded">
                <div class="col-4">
                  <small class="text-muted">
                    <i class="bi bi-arrows-fullscreen text-primary"></i><br>
                    <strong>{{ processed_image.width }}×{{ processed_image.height }}</strong>
                  </small>
                </div>
                <div class="col-4">
                  <small class="text-muted">
                    <i class="bi bi-hdd text-primary"></i><br>
                    <strong>{{ processed_image.file_size|filesizeformat }}</strong>
                  </small>
                </div>
                <div class="col-4">
                  <small class="text-muted">
                    <i class="bi bi-magic text-primary"></i><br>
                    <strong>Wedding AI</strong>
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons Section -->
          <div class="border-bottom">
            <div class="p-4">
              <h6 class="fw-bold text-muted mb-3">
                <i class="bi bi-lightning-fill me-2"></i>Quick Actions
              </h6>
              <div class="row g-3">
                <div class="col-md-3 col-sm-6">
                  <a href="{{ processed_image.processed_image.url }}" 
                     class="btn btn-outline-primary w-100" 
                     target="_blank">
                    <i class="bi bi-arrows-fullscreen mb-1 d-block"></i>
                    <small>View Full Size</small>
                  </a>
                </div>
                <div class="col-md-3 col-sm-6">
                  <a href="{{ processed_image.processed_image.url }}" 
                     class="btn btn-outline-secondary w-100" 
                     download="wedding-{{ theme_display|lower }}-{{ space_display|lower }}.png">
                    <i class="bi bi-download mb-1 d-block"></i>
                    <small>Download</small>
                  </a>
                </div>
                <div class="col-md-3 col-sm-6">
                  <button class="btn btn-outline-info w-100 share-image-btn" 
                          data-image-url="{{ processed_image.processed_image.url }}">
                    <i class="bi bi-share mb-1 d-block"></i>
                    <small>Share</small>
                  </button>
                </div>
                <div class="col-md-3 col-sm-6">
                  <div class="dropdown w-100">
                    <button class="btn btn-outline-success dropdown-toggle w-100" 
                            type="button" 
                            data-bs-toggle="dropdown">
                      <i class="bi bi-collection mb-1 d-block"></i>
                      <small>Add to Collection</small>
                    </button>
                    <ul class="dropdown-menu w-100">
                      <li><h6 class="dropdown-header">Add to Collection</h6></li>
                      <li><a class="dropdown-item add-to-collection" 
                             href="#" 
                             data-processed-image-id="{{ processed_image.id }}"
                             data-collection-type="default">
                        <i class="bi bi-star text-warning"></i> Default Collection
                      </a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <a class="dropdown-item" href="{% url 'image_processing:collections_list' %}">
                          <i class="bi bi-plus"></i> Manage Collections
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>



          <!-- Original Image Reference Section -->
          <div class="border-bottom">
            <div class="p-4">
              <h6 class="fw-bold text-muted mb-3">
                <i class="bi bi-image me-2"></i>Original Venue
              </h6>
              
              <div class="row align-items-center">
                <div class="col-md-3">
                  <img src="{% if processed_image.processing_job.user_image.thumbnail %}{{ processed_image.processing_job.user_image.thumbnail.url }}{% else %}{{ processed_image.processing_job.user_image.image.url }}{% endif %}" 
                       class="img-fluid rounded shadow-sm" 
                       style="width: 100%; max-height: 120px; object-fit: cover;"
                       alt="{{ processed_image.processing_job.user_image.original_filename }}">
                </div>
                <div class="col-md-6">
                  <h6 class="fw-bold mb-1">{{ processed_image.processing_job.user_image.original_filename }}</h6>
                  <p class="text-muted mb-1">
                    <i class="bi bi-arrows-fullscreen me-1"></i>
                    {{ processed_image.processing_job.user_image.width }}×{{ processed_image.processing_job.user_image.height }}
                  </p>
                  <p class="text-muted mb-0">
                    <i class="bi bi-hdd me-1"></i>
                    {{ processed_image.processing_job.user_image.file_size|filesizeformat }}
                  </p>
                </div>
                <div class="col-md-3">
                  <a href="{% url 'image_processing:image_detail' processed_image.processing_job.user_image.pk %}" 
                     class="btn btn-outline-primary w-100">
                    <i class="bi bi-eye me-1"></i> View Original
                  </a>
                </div>
              </div>
            </div>
          </div>

          
            <!-- Processing Details Accordion -->
            <div class="mt-4">
              <div class="accordion" id="processingDetails">
                {% if processed_image.processing_job.generated_prompt %}
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#promptCollapse">
                      <i class="bi bi-code me-2"></i>
                      AI Prompt Used
                    </button>
                  </h2>
                  <div id="promptCollapse" 
                       class="accordion-collapse collapse" 
                       data-bs-parent="#processingDetails">
                    <div class="accordion-body">
                      <div class="bg-light rounded p-3">
                        <code class="small text-muted">{{ processed_image.processing_job.generated_prompt }}</code>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}

                {% if processed_image.processing_job.additional_details %}
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#detailsCollapse">
                      <i class="bi bi-list-ul me-2"></i>
                      Additional Details
                    </button>
                  </h2>
                  <div id="detailsCollapse" 
                       class="accordion-collapse collapse" 
                       data-bs-parent="#processingDetails">
                    <div class="accordion-body">
                      <p class="mb-0">{{ processed_image.processing_job.additional_details }}</p>
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bottom spacing to prevent footer overlap -->
  <div style="height: 60px;"></div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Share Transformation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <img src="{{ processed_image.processed_image.url }}" 
               class="img-fluid rounded" 
               style="max-height: 200px;"
               alt="Transformation preview">
        </div>
        <div class="input-group">
          <input type="text" 
                 class="form-control" 
                 id="shareUrl" 
                 value="{{ request.build_absolute_uri }}" 
                 readonly>
          <button class="btn btn-outline-secondary" type="button" onclick="copyShareUrl()">
            <i class="bi bi-clipboard"></i>
          </button>
        </div>
        <small class="text-muted">Share this transformation with others</small>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Wedding Transformation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this wedding transformation?</p>
        <p class="text-danger"><small><i class="bi bi-exclamation-triangle me-1"></i>This action cannot be undone.</small></p>
        <div class="text-center">
          <img id="deletePreviewImage" 
               class="img-fluid rounded" 
               style="max-height: 200px;" 
               alt="Transformation to delete">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="bi bi-trash me-1"></i> Delete Transformation
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* Unified Card Styling */
.detail-group {
  margin-bottom: 1rem;
}

.detail-label {
  font-weight: 500;
  color: #6c757d;
  font-size: 0.9rem;
}

.bg-gradient-primary {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

/* Responsive image container */
@media (max-width: 768px) {
  .card-body .p-4 {
    padding: 1.5rem !important;
  }
  
  .row.g-3 > .col-md-3 {
    margin-bottom: 0.5rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle delete button
  document.querySelectorAll('.processed-image-delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const imageId = this.dataset.imageId;
      const imageUrl = this.dataset.imageUrl;
      showDeleteModal(imageId, imageUrl);
    });
  });

  // Handle add to collection
  document.querySelectorAll('.add-to-collection').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const processedImageId = this.dataset.processedImageId;
      addToDefaultCollection('processed', processedImageId);
    });
  });
});

function showShareModal() {
  const modal = new bootstrap.Modal(document.getElementById('shareModal'));
  modal.show();
}

function copyShareUrl() {
  const urlInput = document.getElementById('shareUrl');
  urlInput.select();
  document.execCommand('copy');
  
  // Show feedback
  const btn = event.target.closest('button');
  const originalHTML = btn.innerHTML;
  btn.innerHTML = '<i class="bi bi-check"></i>';
  btn.classList.add('btn-success');
  btn.classList.remove('btn-outline-secondary');
  
  setTimeout(() => {
    btn.innerHTML = originalHTML;
    btn.classList.remove('btn-success');
    btn.classList.add('btn-outline-secondary');
  }, 2000);
}

function showDeleteModal(imageId, imageUrl) {
  const modal = document.getElementById('deleteConfirmModal');
  const previewImg = document.getElementById('deletePreviewImage');
  const confirmBtn = document.getElementById('confirmDeleteBtn');
  
  previewImg.src = imageUrl;
  
  confirmBtn.onclick = function() {
    deleteProcessedImage(imageId);
  };
  
  new bootstrap.Modal(modal).show();
}

async function deleteProcessedImage(imageId) {
  try {
    const response = await fetch(`/studio/processed/${imageId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
      showAlert(result.message, 'success');
      
      if (result.redirect_url) {
        setTimeout(() => {
          window.location.href = result.redirect_url;
        }, 1500);
      }
    } else {
      showAlert(result.message || 'Failed to delete image', 'danger');
    }
  } catch (error) {
    console.error('Delete error:', error);
    showAlert('Network error occurred', 'danger');
  }
}

async function addToDefaultCollection(imageType, imageId) {
  const formData = new FormData();
  formData.append('use_default', 'true');
  formData.append('processed_image_id', imageId);
  
  try {
    const response = await fetch('/studio/collections/add/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken()
      },
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      showAlert(result.message, 'success');
    } else {
      showAlert(result.message || 'Failed to add to collection', 'warning');
    }
  } catch (error) {
    console.error('Collection error:', error);
    showAlert('Network error', 'error');
  }
}

function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
         document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
}

function showAlert(message, type) {
  // Remove existing alerts
  document.querySelectorAll('.temp-alert').forEach(alert => alert.remove());
  
  const alert = document.createElement('div');
  alert.className = `alert alert-${type} alert-dismissible fade show position-fixed temp-alert`;
  alert.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 350px;';
  alert.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill'} me-2"></i>
      <div>${message}</div>
      <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
    </div>
  `;
  
  document.body.appendChild(alert);
  
  setTimeout(() => {
    if (alert.parentElement) alert.remove();
  }, 5000);
}
</script>
{% endblock %}