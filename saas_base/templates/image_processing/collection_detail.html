{% extends "base.html" %}
{% load static %}

{% block title %}{{ collection.name }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-md-8">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'image_processing:wedding_studio' %}">Wedding Studio</a></li>
          <li class="breadcrumb-item"><a href="{% url 'image_processing:collections_list' %}">Collections</a></li>
          <li class="breadcrumb-item active">{{ collection.name }}</li>
        </ol>
      </nav>
      <h1>{{ collection.name }}</h1>
      {% if collection.description %}
        <p class="text-muted">{{ collection.description }}</p>
      {% endif %}
      <div class="d-flex gap-3 flex-wrap">
        <small class="text-muted">
          {{ collection.item_count }} item{{ collection.item_count|pluralize }} • 
          Updated {{ collection.updated_at|timesince }} ago
        </small>
      </div>
    </div>
    <div class="col-md-4 text-end">
      <div class="btn-group" role="group">
        <a href="{% url 'image_processing:wedding_studio' %}" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Add More Images
        </a>
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="bi bi-gear"></i>
        </button>
        <ul class="dropdown-menu">
          <li>
            <a class="dropdown-item edit-collection-btn" 
               href="#" 
               data-collection-id="{{ collection.id }}"
               data-collection-name="{{ collection.name }}"
               data-collection-description="{{ collection.description }}">
              <i class="bi bi-pencil text-primary"></i> Edit Collection
            </a>
          </li>
          <li>
            <a class="dropdown-item share-collection-btn" 
               href="#" 
               data-collection-id="{{ collection.id }}">
              <i class="bi bi-share text-info"></i> Share Collection
            </a>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item text-danger delete-collection-btn" 
               href="#" 
               data-collection-id="{{ collection.id }}"
               data-collection-name="{{ collection.name }}">
              <i class="bi bi-trash"></i> Delete Collection
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  {% if items %}
    <!-- Collection Items Grid -->
    <div class="row">
      {% for item in items %}
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4 collection-item" data-item-id="{{ item.id }}">
          <div class="card h-100">
            <div class="position-relative">
              <img src="{{ item.image_url }}" 
                   class="card-img-top" 
                   alt="{{ item.image_title }}"
                   style="height: 200px; object-fit: cover;">
              
              <!-- Type Badge -->
              <div class="position-absolute top-0 start-0 p-2">
                {% if item.processed_image %}
                  <span class="badge bg-success">
                    <i class="bi bi-magic"></i> Transformation
                  </span>
                {% else %}
                  <span class="badge bg-primary">
                    <i class="bi bi-image"></i> Original
                  </span>
                {% endif %}
              </div>
              
              <!-- Favorite Heart for Processed Images -->
              {% if item.processed_image %}
                <div class="position-absolute bottom-0 start-0 p-2">
                  {% include 'image_processing/components/favorite_heart.html' with processed_image=item.processed_image %}
                </div>
              {% endif %}
              
              <!-- Remove from Collection -->
              <div class="position-absolute top-0 end-0 p-2">
                <button class="btn btn-sm btn-outline-light remove-from-collection-btn" 
                        data-item-id="{{ item.id }}"
                        data-collection-id="{{ collection.id }}"
                        data-item-title="{{ item.image_title }}"
                        title="Remove from collection">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>
            
            <div class="card-body">
              <h6 class="card-title text-truncate">{{ item.image_title }}</h6>
              
              {% if item.processed_image %}
                <!-- Wedding transformation details -->
                {% with job=item.processed_image.processing_job %}
                  {% if job.wedding_theme and job.space_type %}
                    <div class="mb-2">
                      <span class="badge bg-primary me-1">{{ item.theme_display }}</span>
                      <span class="badge bg-secondary">{{ item.space_display }}</span>
                    </div>
                  {% endif %}
                  
                  <!-- Optional parameters display -->
                  {% if job.season or job.lighting_mood or job.color_scheme %}
                    <div class="mb-2">
                      {% if job.season %}
                        <span class="badge bg-warning text-dark small">{{ job.season|title }}</span>
                      {% endif %}
                      {% if job.lighting_mood %}
                        <span class="badge bg-secondary small">{{ job.lighting_mood|title }}</span>
                      {% endif %}
                      {% if job.color_scheme %}
                        <span class="badge bg-success small">{{ job.color_scheme|title }}</span>
                      {% endif %}
                    </div>
                  {% endif %}
                {% endwith %}
                
                <small class="text-muted">
                  <i class="bi bi-magic"></i> Wedding Transformation<br>
                  <i class="bi bi-calendar"></i> Created {{ item.processed_image.created_at|date:"M d, Y" }}
                </small>
               
              {% else %}
                <!-- Original image details -->
                <small class="text-muted">
                  <i class="bi bi-image"></i> {{ item.user_image.width }}×{{ item.user_image.height }} • 
                  {{ item.user_image.file_size|filesizeformat }}<br>
                  <i class="bi bi-calendar"></i> Uploaded {{ item.user_image.uploaded_at|timesince }} ago
                </small>
              {% endif %}
              
              {% if item.notes %}
                <div class="mt-2">
                  <small class="text-muted">
                    <i class="bi bi-sticky"></i> {{ item.notes|truncatewords:10 }}
                  </small>
                </div>
              {% endif %}
              
              <small class="text-muted d-block mt-2">
                <i class="bi bi-collection-fill text-primary"></i> Added {{ item.added_at|timesince }} ago
              </small>
            </div>
            
            <div class="card-footer bg-transparent">
              <div class="row g-1">
                {% if item.processed_image %}
                  <!-- Transformation Actions -->
                  <div class="col-6">
                    <a href="{% url 'image_processing:processed_image_detail' item.processed_image.pk %}" 
                       class="btn btn-sm btn-success w-100">
                      <i class="bi bi-eye"></i> View
                    </a>
                  </div>
                  <div class="col-6">
                    <button class="btn btn-sm btn-outline-primary w-100 redo-transformation-btn" 
                            data-job-id="{{ item.processed_image.processing_job.id }}"
                            onclick="redoTransformation('{{ item.processed_image.processing_job.id }}');"
                            title="Use these settings again with a different image">
                      <i class="bi bi-arrow-repeat"></i> Redo
                    </button>
                  </div>
                {% else %}
                  <!-- Original Image Actions -->
                  <div class="col-6">
                    <a href="{% url 'image_processing:wedding_studio' %}?image_id={{ item.user_image.pk }}" 
                       class="btn btn-sm btn-primary w-100">
                      <i class="bi bi-magic"></i> Transform
                    </a>
                  </div>
                  <div class="col-6">
                    <a href="{% url 'image_processing:image_detail' item.user_image.pk %}" 
                       class="btn btn-sm btn-outline-secondary w-100">
                      <i class="bi bi-eye"></i> View
                    </a>
                  </div>
                {% endif %}
              </div>
              <!-- Additional actions row -->
              <div class="row g-1 mt-1">
                <div class="col-4">
                  {% if item.processed_image %}
                    <a href="{{ item.processed_image.processed_image.url }}" 
                       class="btn btn-sm btn-outline-secondary w-100" 
                       target="_blank"
                       title="View full size">
                      <i class="bi bi-arrows-fullscreen"></i>
                    </a>
                  {% else %}
                    <a href="{{ item.user_image.image.url }}" 
                       class="btn btn-sm btn-outline-secondary w-100" 
                       target="_blank"
                       title="View full size">
                      <i class="bi bi-arrows-fullscreen"></i>
                    </a>
                  {% endif %}
                </div>
                <div class="col-4">
                  {% if item.processed_image %}
                    <a href="{{ item.processed_image.processed_image.url }}" 
                       class="btn btn-sm btn-outline-primary w-100" 
                       download
                       title="Download image">
                      <i class="bi bi-download"></i>
                    </a>
                  {% else %}
                    <a href="{{ item.user_image.image.url }}" 
                       class="btn btn-sm btn-outline-primary w-100" 
                       download="{{ item.user_image.original_filename }}"
                       title="Download image">
                      <i class="bi bi-download"></i>
                    </a>
                  {% endif %}
                </div>
                <div class="col-4">
                  <button class="btn btn-sm btn-outline-danger w-100 remove-from-collection-btn" 
                          data-item-id="{{ item.id }}"
                          data-collection-id="{{ collection.id }}"
                          data-item-title="{{ item.image_title }}"
                          onclick="showRemoveConfirmation('{{ item.id }}', '{{ collection.id }}', '{{ item.image_title }}');"
                          title="Remove from collection">
                    <i class="bi bi-x"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <!-- Empty collection -->
    <div class="row">
      <div class="col-12">
        <div class="text-center py-5">
          <i class="bi bi-collection text-muted" style="font-size: 4rem;"></i>
          <h3 class="mt-3 text-muted">Collection is Empty</h3>
          <p class="text-muted">Start adding wedding venue photos and transformations to this collection</p>
          <div class="mt-4">
            <a href="{% url 'image_processing:wedding_studio' %}" class="btn btn-primary btn-lg me-3">
              <i class="bi bi-plus-circle"></i> Upload & Transform
            </a>
            <a href="{% url 'image_processing:image_gallery' %}" class="btn btn-outline-secondary btn-lg">
              <i class="bi bi-images"></i> Browse Gallery
            </a>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- Remove from Collection Confirmation Modal -->
<div class="modal fade" id="removeFromCollectionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Remove from Collection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to remove <strong id="removeItemName"></strong> from this collection?</p>
        <p class="text-muted"><small>The original image will not be deleted, it will just be removed from this collection.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmRemoveBtn">Remove from Collection</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Collection Modal -->
<div class="modal fade" id="editCollectionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Collection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editCollectionForm" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="editCollectionName" class="form-label">Collection Name</label>
            <input type="text" class="form-control" id="editCollectionName" name="name" required maxlength="100">
          </div>
          <div class="mb-3">
            <label for="editCollectionDescription" class="form-label">Description (Optional)</label>
            <textarea class="form-control" id="editCollectionDescription" name="description" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Collection</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Collection Modal -->
<div class="modal fade" id="deleteCollectionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Collection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the collection <strong id="deleteCollectionName"></strong>?</p>
        <p class="text-danger"><small>This action cannot be undone. All items in this collection will be removed from the collection (but the original images will not be deleted).</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteCollectionBtn">Delete Collection</button>
      </div>
    </div>
  </div>
</div>

<!-- Share Collection Modal -->
<div class="modal fade" id="shareCollectionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Share Collection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Share this collection with others:</p>
        <div class="input-group">
          <input type="text" class="form-control" id="shareCollectionUrl" readonly>
          <button class="btn btn-outline-secondary" type="button" id="copyShareUrl">
            <i class="bi bi-clipboard"></i> Copy
          </button>
        </div>
        <small class="text-muted">Share this link to let others view your collection.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
/* Enhanced styling matching simplified design */
.collection-item {
  transition: all 0.3s ease;
}

.collection-item .card {
  transition: all 0.3s ease;
  border: 1px solid #dee2e6;
}

.collection-item:hover .card {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

.card-img-top {
  transition: all 0.3s ease;
}

.collection-item:hover .card-img-top {
  transform: scale(1.02);
}

/* Badge styling */
.badge {
  font-size: 0.75rem;
}

.badge.small {
  font-size: 0.7rem;
}

/* Button styling */
.btn-sm {
  font-size: 0.8rem;
  padding: 0.25rem 0.5rem;
}

/* Remove button styling */
.remove-from-collection-btn {
  opacity: 0.7;
  transition: all 0.2s ease;
}

.remove-from-collection-btn:hover {
  opacity: 1;
  background-color: rgba(220, 53, 69, 0.1);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .card-body {
    padding: 1rem;
  }
  
  .btn-sm {
    font-size: 0.75rem;
    padding: 0.2rem 0.4rem;
  }
  
  .badge {
    font-size: 0.7rem;
  }
}

@media (max-width: 576px) {
  .card-img-top {
    height: 180px !important;
  }
  
  .btn-sm {
    font-size: 0.7rem;
    padding: 0.15rem 0.3rem;
  }
}
</style>

<script>
// Collection Detail Management JavaScript - FIXED VERSION
document.addEventListener('DOMContentLoaded', function() {
    console.log('Setting up collection detail management...');
    
    // Edit Collection - FIXED
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-collection-btn') || e.target.closest('.edit-collection-btn')) {
            e.preventDefault();
            handleEditCollection(e.target.closest('.edit-collection-btn') || e.target);
        }
    });
    
    // Delete Collection
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-collection-btn') || e.target.closest('.delete-collection-btn')) {
            e.preventDefault();
            handleDeleteCollection(e.target.closest('.delete-collection-btn') || e.target);
        }
    });
    
    // Share Collection
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('share-collection-btn') || e.target.closest('.share-collection-btn')) {
            e.preventDefault();
            handleShareCollection(e.target.closest('.share-collection-btn') || e.target);
        }
    });
    
    // Edit Collection Form Submit - FIXED
    const editForm = document.getElementById('editCollectionForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitEditCollection();
        });
    }
    
    // Copy Share URL
    const copyBtn = document.getElementById('copyShareUrl');
    if (copyBtn) {
        copyBtn.addEventListener('click', function() {
            const urlInput = document.getElementById('shareCollectionUrl');
            urlInput.select();
            document.execCommand('copy');
            
            // Show feedback
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            copyBtn.classList.add('btn-success');
            copyBtn.classList.remove('btn-outline-secondary');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-secondary');
            }, 2000);
        });
    }
});

let currentCollectionId = null;

// Redo transformation functionality
async function redoTransformation(jobId) {
    try {
        showAlert('Copying settings to studio...', 'info');
        
        const response = await fetch(`/studio/redo-transformation/${jobId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.href = result.redirect_url;
        } else {
            showAlert('Failed to copy settings', 'danger');
        }
    } catch (error) {
        console.error('Redo transformation error:', error);
        showAlert('Error copying settings', 'danger');
    }
}

function showRemoveConfirmation(itemId, collectionId, itemTitle) {
    document.getElementById('removeItemName').textContent = itemTitle;
    
    const confirmBtn = document.getElementById('confirmRemoveBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.addEventListener('click', function() {
        removeFromCollection(itemId, collectionId);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('removeFromCollectionModal'));
    modal.show();
}

async function removeFromCollection(itemId, collectionId) {
    try {
        const response = await fetch(`/studio/collections/${collectionId}/remove/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('removeFromCollectionModal'));
            modal.hide();
            
            showAlert(result.message, 'success');
            
            const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
            if (itemElement) {
                itemElement.style.transition = 'all 0.3s ease';
                itemElement.style.transform = 'scale(0.8)';
                itemElement.style.opacity = '0';
                
                setTimeout(() => {
                    itemElement.remove();
                    
                    const remainingItems = document.querySelectorAll('.collection-item');
                    if (remainingItems.length === 0) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                }, 300);
            }
        } else {
            showAlert(result.message || 'Failed to remove from collection', 'danger');
        }
    } catch (error) {
        console.error('Remove from collection error:', error);
        showAlert('Error removing from collection', 'danger');
    }
}

function handleEditCollection(button) {
    console.log('Edit collection clicked');
    
    const collectionId = button.dataset.collectionId;
    const collectionName = button.dataset.collectionName;
    const collectionDescription = button.dataset.collectionDescription || '';
    
    currentCollectionId = collectionId;
    
    // Fill form
    document.getElementById('editCollectionName').value = collectionName;
    document.getElementById('editCollectionDescription').value = collectionDescription;
    
    // Update form action
    const form = document.getElementById('editCollectionForm');
    form.action = `/studio/collections/${collectionId}/edit/`;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editCollectionModal'));
    modal.show();
}

function handleDeleteCollection(button) {
    console.log('Delete collection clicked');
    
    const collectionId = button.dataset.collectionId;
    const collectionName = button.dataset.collectionName;
    
    currentCollectionId = collectionId;
    
    document.getElementById('deleteCollectionName').textContent = collectionName;
    
    const confirmBtn = document.getElementById('confirmDeleteCollectionBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.addEventListener('click', function() {
        executeDeleteCollection(collectionId);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('deleteCollectionModal'));
    modal.show();
}

function handleShareCollection(button) {
    console.log('Share collection clicked');
    
    const collectionId = button.dataset.collectionId;
    
    const shareUrl = `${window.location.origin}/studio/collections/${collectionId}/`;
    document.getElementById('shareCollectionUrl').value = shareUrl;
    
    const modal = new bootstrap.Modal(document.getElementById('shareCollectionModal'));
    modal.show();
}

async function submitEditCollection() {
    console.log('Submitting collection edit...');
    
    if (!currentCollectionId) return;
    
    const form = document.getElementById('editCollectionForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch(`/studio/collections/${currentCollectionId}/edit/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editCollectionModal'));
            modal.hide();
            
            showAlert(data.message, 'success');
            
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Error updating collection');
        }
    } catch (error) {
        console.error('Edit collection error:', error);
        showAlert('Error updating collection: ' + error.message, 'error');
    }
}

async function executeDeleteCollection(collectionId) {
    console.log(`Executing collection delete ${collectionId}...`);
    
    try {
        const response = await fetch(`/studio/collections/${collectionId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteCollectionModal'));
            modal.hide();
            
            showAlert(data.message, 'success');
            
            setTimeout(() => {
                window.location.href = '/studio/collections/';
            }, 1500);
        } else {
            throw new Error(data.error || 'Delete failed');
        }
    } catch (error) {
        console.error('Delete collection error:', error);
        showAlert('Error deleting collection: ' + error.message, 'error');
    }
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
           document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
}

function showAlert(message, type) {
    document.querySelectorAll('.temp-alert').forEach(alert => alert.remove());
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed temp-alert`;
    alert.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 350px;';
    alert.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill'} me-2"></i>
            <div>${message}</div>
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentElement) alert.remove();
    }, 5000);
}
</script>
{% endblock %}