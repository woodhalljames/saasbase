{% extends "base.html" %}
{% load static %}

{% block title %}Wedding Studio - AI Transformation{% endblock %}
{% block css %}
{{ block.super }}
<link rel="canonical" href="{{ request.scheme }}://{{ request.get_host }}{% url 'image_processing:wedding_studio' %}">
<style>
/* Studio Mode Tabs */
.studio-mode-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
}

.studio-mode-tab {
  flex: 1;
  padding: 0.75rem;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
}

.studio-mode-tab:hover {
  border-color: #00F5FF;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.studio-mode-tab.active {
  border-color: #00F5FF;
  background: rgba(0, 245, 255, 0.1);
}

.studio-mode-tab .mode-icon {
  font-size: 1.5rem;
  margin-bottom: 0.25rem;
}

.studio-mode-tab .mode-name {
  font-weight: 600;
  font-size: 0.9rem;
}

/* Selected Images Card */
.selected-images-card {
  min-height: 500px;
  max-height: 500px;
  overflow-y: auto;
}

.selected-image-item {
  position: relative;
  width: 100%;
  aspect-ratio: 1;
  border-radius: 4px;
  overflow: hidden;
  border: 2px solid #00F5FF;
  cursor: move;
  margin-bottom: 0.5rem;
  max-width: 80px;
  margin-left: auto;
  margin-right: auto;
}

.selected-image-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.selected-image-item .remove-btn {
  position: absolute;
  top: 2px;
  right: 2px;
  width: 18px;
  height: 18px;
  background: #dc3545;
  color: white;
  border-radius: 50%;
  border: none;
  font-size: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 2;
}

.selected-image-item .order-badge {
  position: absolute;
  bottom: 2px;
  left: 2px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: bold;
  z-index: 2;
}

.selected-images-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: #6c757d;
  font-size: 0.9rem;
  text-align: center;
}

/* Favorite uploads section */
.favorite-uploads-section {
  padding: 1rem;
  background: #fff;
  border-radius: 8px;
  border: 1px solid #dee2e6;
}

.favorite-upload-item {
  position: relative;
  width: 100px;
  height: 100px;
  border-radius: 4px;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s ease;
}

.favorite-upload-item:hover {
  border-color: #00F5FF;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.favorite-upload-item.selected {
  border-color: #28a745;
  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
}

.favorite-upload-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.favorite-upload-item .star-badge {
  position: absolute;
  top: 4px;
  left: 4px;
  background: rgba(255, 193, 7, 0.9);
  color: white;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
}

/* Upload zone */
.upload-zone {
  border: 2px dashed #dee2e6;
  border-radius: 15px;
  transition: all 0.3s ease;
  cursor: pointer;
  background: rgba(248, 249, 250, 0.5);
  min-height: 500px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 2rem;
}

.upload-zone:hover,
.upload-zone.dragover {
  border-color: #00F5FF;
  background-color: rgba(0, 245, 255, 0.05);
  transform: scale(1.01);
}

/* Mode-specific field groups */
.mode-fields {
  display: none;
}

.mode-fields.active {
  display: block;
}

/* Venue thumbnail styling */
.venue-thumbnail {
  transition: all 0.2s ease;
  border: 2px solid transparent !important;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.venue-thumbnail:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  border-color: #00F5FF !important;
}

.venue-thumbnail.selected {
  border-color: #28a745 !important;
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.venue-thumbnail.selected::after {
  content: '‚úì';
  position: absolute;
  top: 4px;
  right: 4px;
  background: #28a745;
  color: white;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
}

.object-fit-cover {
  object-fit: cover;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3" style="max-width: 1400px;">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h1 class="h2 mb-2">Wedding Studio</h1>
      <p class="text-muted mb-0">Transform spaces or create portraits with AI</p>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="row g-4">
    
    <!-- Left: Studio Controls -->
    <div class="col-xl-3 col-lg-3 col-md-12">
      <div class="card shadow-sm" style="min-height: 500px;">
        <div class="card-header py-2 bg-primary text-white">
          <h6 class="mb-0 fw-bold">üé® Studio Settings</h6>
        </div>
        <div class="card-body p-3">
          <form id="transformForm">
            {% csrf_token %}
            
            <!-- Studio Mode Selection -->
            <div class="mb-3">
              <label class="form-label fw-bold small">Studio Mode</label>
              <div class="studio-mode-tabs">
                <div class="studio-mode-tab active" data-mode="venue">
                  <div class="mode-icon">üèõÔ∏è</div>
                  <div class="mode-name">Venue</div>
                </div>
                <div class="studio-mode-tab" data-mode="portrait_wedding">
                  <div class="mode-icon">üë∞</div>
                  <div class="mode-name">Wedding</div>
                </div>
                <div class="studio-mode-tab" data-mode="portrait_engagement">
                  <div class="mode-icon">üíï</div>
                  <div class="mode-name">Engagement</div>
                </div>
              </div>
              <input type="hidden" id="studio-mode" name="studio_mode" value="venue">
            </div>

            <!-- VENUE MODE FIELDS -->
            <div class="mode-fields active" id="venue-fields">
              <div class="mb-3">
                <label for="wedding-theme" class="form-label fw-bold small">Wedding Style <span class="text-danger">*</span></label>
                <select class="form-select" id="wedding-theme" name="wedding_theme">
                  <option value="">Choose style...</option>
                  {% for value, label in wedding_themes %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
                <small class="form-text text-muted">Required: Pick your wedding style</small>
              </div>
              
              <div class="mb-3">
                <label for="space-type" class="form-label fw-bold small">Space Type</label>
                <select class="form-select" id="space-type" name="space_type">
                  <option value="">Choose space (optional)...</option>
                  {% for value, label in space_types %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
                <small class="form-text text-muted">Optional: Specify the type of space</small>
              </div>
            </div>

            <!-- PORTRAIT MODE FIELDS -->
            <div class="mode-fields" id="portrait-fields">
              <div class="mb-3">
                <label for="setting-type" class="form-label fw-bold small">Setting</label>
                <select class="form-select" id="setting-type" name="setting_type">
                  <option value="">Choose setting (optional)...</option>
                  {% for value, label in portrait_settings %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
                <small class="form-text text-muted">Optional: Where should the photo be taken</small>
              </div>

              <div class="mb-3">
                <label for="pose-style" class="form-label fw-bold small">Pose/Action <span class="text-danger">*</span></label>
                <select class="form-select" id="pose-style" name="pose_style">
                  <option value="">Choose pose...</option>
                  <option value="formal_portrait">Formal Portrait</option>
                  <option value="romantic_embrace">Romantic Embrace</option>
                  <option value="candid_laughing">Candid & Laughing</option>
                  <option value="walking_together">Walking Together</option>
                  <option value="sitting_intimate">Sitting Intimate</option>
                  <option value="dancing">Dancing</option>
                  <option value="playful_fun">Playful & Fun</option>
                </select>
                <small class="form-text text-muted">Required: How should subjects be posed</small>
              </div>
            </div>

            <!-- Optional Details -->
            <div class="border-top pt-3 mt-3">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h6 class="mb-0 text-muted">More Options</h6>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleOptional">
                  <i class="bi bi-chevron-down" id="toggleIcon"></i>
                </button>
              </div>
              
              <div id="optionalFields" class="d-none">
                <!-- Portrait Optional Fields -->
                <div class="portrait-optional-fields d-none">
                  <div class="mb-3">
                    <label for="photo-theme" class="form-label small">Photo Theme</label>
                    <select class="form-select form-select-sm" id="photo-theme" name="photo_theme">
                      <option value="">Choose theme...</option>
                      {% for value, label in portrait_themes %}
                        <option value="{{ value }}">{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="mb-3">
                    <label for="attire-style" class="form-label small">Attire Style</label>
                    <select class="form-select form-select-sm" id="attire-style" name="attire_style">
                      <option value="">Choose attire...</option>
                      <option value="traditional_formal">Traditional Wedding Attire</option>
                      <option value="modern_chic">Modern Chic</option>
                      <option value="casual_elegant">Casual Elegant</option>
                      <option value="bohemian">Bohemian Style</option>
                      <option value="vintage_inspired">Vintage Inspired</option>
                      <option value="cultural_traditional">Cultural Traditional</option>
                    </select>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="season" class="form-label small">Season</label>
                  <select class="form-select form-select-sm" id="season" name="season">
                    {% for value, label in season_choices %}
                      <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="lighting" class="form-label small">Lighting</label>
                  <select class="form-select form-select-sm" id="lighting" name="lighting_mood">
                    {% for value, label in lighting_choices %}
                      <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="color-scheme" class="form-label small">Colors</label>
                  <select class="form-select form-select-sm" id="color-scheme" name="color_scheme">
                    <option value="">Theme default</option>
                    {% for value, label in color_schemes %}
                      <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="user-instructions" class="form-label small">Additional Instructions</label>
                  <textarea class="form-control form-control-sm" id="user-instructions" name="user_instructions" 
                            rows="3" placeholder="Any specific requests..."></textarea>
                </div>
              </div>
            </div>
            
            <div class="d-grid">
              <button type="submit" class="btn btn-secondary py-2" id="transformBtn" disabled>
                <i class="bi bi-magic me-1"></i> <span>Select Images First</span>
              </button>
            </div>
            
            {% if usage_data %}
            <div class="text-center mt-2">
              <small class="text-muted">
                {{ usage_data.remaining }} of {{ usage_data.limit }} remaining
              </small>
            </div>
            {% endif %}
          </form>
        </div>
      </div>
    </div>

    <!-- Center: Upload Area -->
    <div class="col-xl-6 col-lg-5 col-md-12">
      <div class="card shadow-sm" style="min-height: 500px;">
        <div class="card-body p-4">
          
          <!-- Upload Area -->
          <div id="uploadArea">
            <div class="upload-zone" id="dropZone">
              <div class="mb-4">
                <button type="button" class="btn btn-primary btn-lg upload-btn" id="uploadBtn">
                  <i class="bi bi-cloud-upload me-2"></i> Upload Images
                </button>
                <button type="button" class="btn btn-outline-primary btn-lg ms-3 d-md-none camera-btn" id="cameraBtn">
                  <i class="bi bi-camera me-2"></i> Take Photo
                </button>
              </div>
              
              <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.webp,image/jpeg,image/png,image/webp" multiple class="d-none">
              <input type="file" id="cameraInput" accept=".jpg,.jpeg,.png,.webp,image/jpeg,image/png,image/webp" capture="environment" class="d-none">
              
              <i class="bi bi-cloud-upload text-primary mb-3" style="font-size: 4rem;"></i>
              <h4 class="mb-3" id="uploadTitle">Upload Your Images</h4>
              <p class="text-muted mb-3" id="uploadDescription">Select up to 3 images (venue photos, selfies, references)</p>
              <p class="text-muted small mb-0"><strong>JPG, PNG, WebP</strong> ‚Ä¢ Max 10MB each</p>
            </div>
          </div>

          <!-- Upload Progress -->
          <div id="uploadProgress" class="text-center w-100 d-none">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
            <h5 id="uploadProgressText">Uploading...</h5>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Selected Images -->
    <div class="col-xl-3 col-lg-4 col-md-12">
      <div class="card shadow-sm selected-images-card">
        <div class="card-header py-2 bg-success text-white">
          <h6 class="mb-0 fw-bold">
            <i class="bi bi-images me-1"></i>
            Selected (<span id="selectedCount">0</span>/3)
          </h6>
        </div>
        <div class="card-body p-3" id="selectedImagesContainer">
          <div class="selected-images-placeholder">
            <i class="bi bi-images mb-2" style="font-size: 3rem;"></i>
            <p class="mb-0">No images selected</p>
            <small class="text-muted">Select 1-3 images</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Favorite Uploads Section -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header py-2 bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold">‚≠ê Favorite Uploads - Quick Add</h6>
            <small class="text-muted">Click to add to selection</small>
          </div>
        </div>
        <div class="card-body p-3">
          <div id="favoriteUploadsContainer" class="d-flex gap-2 flex-wrap">
            <div class="text-muted small">
              <i class="bi bi-star me-1"></i>Star images from Recent Images below for quick access
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header py-2 bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold">üì∏ Recent Images</h6>
            <a href="{% url 'image_processing:image_gallery' %}" class="btn btn-sm btn-outline-primary">
              View All
            </a>
          </div>
        </div>
        <div class="card-body p-3">
          {% if recent_images %}
            <div class="row g-2" id="recentImagesContainer">
              {% for image in recent_images|slice:":12" %}
                <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xl-1">
                  <div class="venue-thumbnail border rounded overflow-hidden position-relative" 
                       data-image-id="{{ image.id }}"
                       data-image-url="{{ image.image.url }}"
                       data-thumbnail-url="{% if image.thumbnail %}{{ image.thumbnail.url }}{% else %}{{ image.image.url }}{% endif %}"
                       data-image-name="{{ image.original_filename }}"
                       style="cursor: pointer; aspect-ratio: 1; height: 100px;">
                    <img src="{% if image.thumbnail %}{{ image.thumbnail.url }}{% else %}{{ image.image.url }}{% endif %}" 
                         class="w-100 h-100 object-fit-cover" 
                         alt="{{ image.original_filename }}">
                    <div class="position-absolute top-0 start-0 m-1">
                      {% include 'image_processing/components/favorite_star.html' with user_image=image %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="bi bi-images text-muted fs-4"></i>
              <p class="text-muted mb-0 mt-2">No uploads yet</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeMultiModeStudio();
});

function initializeMultiModeStudio() {
    console.log('üé¨ Initializing Multi-Mode Studio...');
    
    class MultiModeStudio {
        constructor() {
            this.selectedImages = [];
            this.favoriteUploads = [];
            this.currentMode = 'venue';
            this.maxImages = 3;
            this.allowedFormats = ['jpg', 'jpeg', 'png', 'webp'];
            this.init();
        }

        init() {
            this.setupModeToggle();
            this.setupUploadButtons();
            this.setupFileInputs();
            this.setupDropZone();
            this.setupThumbnails();
            this.setupForm();
            this.setupOptionalFields();
            this.loadFavoriteUploads();
            this.updateUploadText();
            
            document.addEventListener('favoriteUploadChanged', (e) => {
                console.log('‚≠ê Favorite upload changed event received:', e.detail);
                this.loadFavoriteUploads();
            });
            
            console.log('‚úÖ Multi-Mode Studio ready!');
        }

        validateFileFormat(file) {
            const fileName = file.name.toLowerCase();
            const fileExt = fileName.split('.').pop();
            
            if (!this.allowedFormats.includes(fileExt)) {
                return {
                    valid: false,
                    error: `Invalid format ".${fileExt}". Please upload JPG, PNG, or WebP images only.`
                };
            }
            
            const validMimeTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validMimeTypes.includes(file.type)) {
                return {
                    valid: false,
                    error: `Invalid file type. Please upload JPG, PNG, or WebP images only.`
                };
            }
            
            return { valid: true };
        }

        setupModeToggle() {
            const modeTabs = document.querySelectorAll('.studio-mode-tab');
            const studioModeInput = document.getElementById('studio-mode');
            const portraitOptionalFields = document.querySelector('.portrait-optional-fields');

            modeTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const mode = tab.dataset.mode;
                    
                    modeTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    studioModeInput.value = mode;
                    this.currentMode = mode;
                    
                    document.querySelectorAll('.mode-fields').forEach(f => f.classList.remove('active'));
                    if (mode === 'venue') {
                        document.getElementById('venue-fields').classList.add('active');
                        if (portraitOptionalFields) {
                            portraitOptionalFields.classList.add('d-none');
                        }
                    } else {
                        document.getElementById('portrait-fields').classList.add('active');
                        if (portraitOptionalFields) {
                            portraitOptionalFields.classList.remove('d-none');
                        }
                    }
                    
                    this.updateUploadText();
                    this.updateTransformButton();
                    
                    console.log('üîÑ Switched to mode:', mode);
                });
            });
        }

        updateUploadText() {
            const title = document.getElementById('uploadTitle');
            const description = document.getElementById('uploadDescription');
            
            if (this.currentMode === 'venue') {
                title.textContent = 'Upload Your Images';
                description.textContent = 'Select up to 3 images (venue photos, references)';
            } else {
                title.textContent = 'Upload Your Images';
                description.textContent = 'Select up to 3 images (faces, clothing, location inspiration)';
            }
        }

        setupUploadButtons() {
            const uploadBtn = document.getElementById('uploadBtn');
            const cameraBtn = document.getElementById('cameraBtn');
            const fileInput = document.getElementById('fileInput');
            const cameraInput = document.getElementById('cameraInput');

            if (uploadBtn) {
                uploadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    fileInput.click();
                });
            }

            if (cameraBtn) {
                cameraBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    cameraInput.click();
                });
            }
        }

        setupFileInputs() {
            const fileInput = document.getElementById('fileInput');
            const cameraInput = document.getElementById('cameraInput');

            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    this.handleMultipleFileUpload(Array.from(e.target.files));
                });
            }

            if (cameraInput) {
                cameraInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleMultipleFileUpload(Array.from(e.target.files));
                    }
                });
            }
        }

        setupDropZone() {
            const dropZone = document.getElementById('dropZone');

            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });

                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                    if (files.length > 0) {
                        this.handleMultipleFileUpload(files);
                    }
                });
            }
        }

        async handleMultipleFileUpload(files) {
            const remainingSlots = this.maxImages - this.selectedImages.length;
            
            if (remainingSlots <= 0) {
                this.showAlert(`Maximum ${this.maxImages} images allowed`, 'warning');
                return;
            }

            const invalidFiles = [];
            const validFiles = [];
            
            for (const file of files) {
                const validation = this.validateFileFormat(file);
                if (validation.valid) {
                    validFiles.push(file);
                } else {
                    invalidFiles.push({ name: file.name, error: validation.error });
                }
            }
            
            if (invalidFiles.length > 0) {
                const errorMsg = invalidFiles.length === 1 
                    ? invalidFiles[0].error 
                    : `${invalidFiles.length} files have invalid formats. Please upload JPG, PNG, or WebP only.`;
                this.showAlert(errorMsg, 'danger');
                
                if (validFiles.length === 0) {
                    return;
                }
            }

            const filesToUpload = validFiles.slice(0, remainingSlots);
            
            if (validFiles.length > remainingSlots) {
                this.showAlert(`Only uploading ${remainingSlots} of ${validFiles.length} images (max ${this.maxImages})`, 'warning');
            }

            this.showUploadProgress();

            for (const file of filesToUpload) {
                await this.uploadSingleFile(file);
            }

            this.hideUploadProgress();
            this.renderSelectedImages();
            this.updateTransformButton();
        }

        async uploadSingleFile(file) {
            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('csrfmiddlewaretoken', this.getCSRFToken());

                const response = await fetch('/studio/upload/', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                const data = await response.json();

                if (data.success) {
                    this.selectedImages.push({
                        id: data.image_id,
                        url: data.image_url,
                        thumbnailUrl: data.thumbnail_url || data.image_url,
                        name: data.image_name
                    });
                    
                    this.addToRecentImages(data);
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                this.showAlert('Upload failed: ' + error.message, 'danger');
            }
        }

        renderSelectedImages() {
            const container = document.getElementById('selectedImagesContainer');
            const countEl = document.getElementById('selectedCount');
            
            if (!container) return;

            countEl.textContent = this.selectedImages.length;

            if (this.selectedImages.length === 0) {
                container.innerHTML = `
                    <div class="selected-images-placeholder">
                        <i class="bi bi-images mb-2" style="font-size: 3rem;"></i>
                        <p class="mb-0">No images selected</p>
                        <small class="text-muted">Select 1-3 images</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            this.selectedImages.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = 'selected-image-item';
                item.dataset.imageId = img.id;
                item.innerHTML = `
                    <img src="${img.thumbnailUrl}" alt="${img.name}">
                    <button class="remove-btn" data-index="${index}">√ó</button>
                    <div class="order-badge">${index + 1}</div>
                `;

                const removeBtn = item.querySelector('.remove-btn');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.removeImage(index);
                });

                container.appendChild(item);
            });
        }

        removeImage(index) {
            this.selectedImages.splice(index, 1);
            this.renderSelectedImages();
            this.updateTransformButton();
            
            const thumbnails = document.querySelectorAll('.venue-thumbnail');
            thumbnails.forEach(t => {
                const imageId = parseInt(t.dataset.imageId);
                if (!this.selectedImages.find(img => img.id === imageId)) {
                    t.classList.remove('selected');
                }
            });
        }

        setupThumbnails() {
            document.addEventListener('click', (e) => {
                const thumbnail = e.target.closest('.venue-thumbnail');
                if (thumbnail && !e.target.closest('.favorite-star-btn')) {
                    this.toggleThumbnailSelection(thumbnail);
                }
            });
        }

        toggleThumbnailSelection(thumbnail) {
            const imageId = parseInt(thumbnail.dataset.imageId);
            const imageUrl = thumbnail.dataset.imageUrl;
            const thumbnailUrl = thumbnail.dataset.thumbnailUrl;
            const imageName = thumbnail.dataset.imageName;

            const existingIndex = this.selectedImages.findIndex(img => img.id === imageId);

            if (existingIndex >= 0) {
                this.selectedImages.splice(existingIndex, 1);
                thumbnail.classList.remove('selected');
            } else {
                if (this.selectedImages.length >= this.maxImages) {
                    this.showAlert(`Maximum ${this.maxImages} images allowed`, 'warning');
                    return;
                }

                this.selectedImages.push({
                    id: imageId,
                    url: imageUrl,
                    thumbnailUrl: thumbnailUrl,
                    name: imageName
                });
                thumbnail.classList.add('selected');
            }

            this.renderSelectedImages();
            this.updateTransformButton();
        }

        addToRecentImages(data) {
            const container = document.getElementById('recentImagesContainer');
            if (!container) return;

            const div = document.createElement('div');
            div.className = 'col-6 col-sm-4 col-md-3 col-lg-2 col-xl-1';
            div.innerHTML = `
                <div class="venue-thumbnail border rounded overflow-hidden position-relative" 
                     data-image-id="${data.image_id}"
                     data-image-url="${data.image_url}"
                     data-thumbnail-url="${data.thumbnail_url || data.image_url}"
                     data-image-name="${data.image_name}"
                     style="cursor: pointer; aspect-ratio: 1; height: 100px;">
                    <img src="${data.thumbnail_url || data.image_url}" 
                         class="w-100 h-100 object-fit-cover" 
                         alt="${data.image_name}">
                    <div class="position-absolute top-0 start-0 m-1">
                        <button type="button" 
                                class="favorite-star-btn not-starred"
                                data-user-image-id="${data.image_id}"
                                data-is-starred="false"
                                title="Add to quick access">
                          <i class="bi bi-star"></i>
                        </button>
                    </div>
                </div>
            `;

            container.insertBefore(div, container.firstChild);

            const thumbs = container.querySelectorAll('.col-6, .col-sm-4, .col-md-3, .col-lg-2, .col-xl-1');
            if (thumbs.length > 12) {
                thumbs[thumbs.length - 1].remove();
            }
        }

        setupForm() {
            const form = document.getElementById('transformForm');
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.processImages();
                });
            }

            // UPDATED: Only listen to required fields
            const requiredFields = ['wedding-theme', 'pose-style'];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', () => this.updateTransformButton());
                }
            });
        }

        setupOptionalFields() {
            const toggleBtn = document.getElementById('toggleOptional');
            const optionalFields = document.getElementById('optionalFields');
            const toggleIcon = document.getElementById('toggleIcon');

            if (toggleBtn && optionalFields && toggleIcon) {
                toggleBtn.addEventListener('click', () => {
                    const isHidden = optionalFields.classList.contains('d-none');
                    if (isHidden) {
                        optionalFields.classList.remove('d-none');
                        toggleIcon.className = 'bi bi-chevron-up';
                    } else {
                        optionalFields.classList.add('d-none');
                        toggleIcon.className = 'bi bi-chevron-down';
                    }
                });
            }
        }

        async loadFavoriteUploads() {
            console.log('üî• Loading favorite uploads...');
            try {
                const response = await fetch('/studio/favorite-uploads/', {
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': this.getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    this.favoriteUploads = data.favorites || [];
                    console.log('‚úÖ Loaded favorites:', this.favoriteUploads.length, 'items');
                    this.renderFavoriteUploads();
                } else {
                    console.error('‚ùå Failed to load favorites:', data);
                }
            } catch (error) {
                console.error('‚ùå Error loading favorites:', error);
            }
        }

        renderFavoriteUploads() {
            const container = document.getElementById('favoriteUploadsContainer');
            if (!container) {
                console.error('‚ùå Favorite uploads container not found');
                return;
            }

            console.log('üé® Rendering', this.favoriteUploads.length, 'favorite uploads');

            if (this.favoriteUploads.length === 0) {
                container.innerHTML = `
                    <div class="text-muted small">
                        <i class="bi bi-star me-1"></i>Star images from Recent Images below for quick access
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            this.favoriteUploads.forEach((fav, index) => {
                const isSelected = this.selectedImages.some(img => img.id === fav.image.id);

                const item = document.createElement('div');
                item.className = `favorite-upload-item ${isSelected ? 'selected' : ''}`;
                item.dataset.imageId = fav.image.id;
                item.dataset.imageUrl = fav.image.url;
                item.dataset.thumbnailUrl = fav.image.thumbnail_url;
                item.dataset.imageName = fav.image.name;
                item.title = `${fav.image.name} - Click to ${isSelected ? 'remove' : 'add'}`;

                item.innerHTML = `
                    <img src="${fav.image.thumbnail_url}" alt="${fav.image.name}">
                    <div class="star-badge"><i class="bi bi-star-fill"></i></div>
                `;

                item.addEventListener('click', () => {
                    this.toggleFavoriteUploadSelection(item);
                });

                container.appendChild(item);
                
                console.log(`  ‚úÖ Added favorite #${index + 1}:`, fav.image.name);
            });
            
            console.log('‚úÖ Rendered', this.favoriteUploads.length, 'favorites');
        }

        toggleFavoriteUploadSelection(item) {
            const imageId = parseInt(item.dataset.imageId);
            const existingIndex = this.selectedImages.findIndex(img => img.id === imageId);

            if (existingIndex >= 0) {
                this.selectedImages.splice(existingIndex, 1);
                item.classList.remove('selected');
            } else {
                if (this.selectedImages.length >= this.maxImages) {
                    this.showAlert(`Maximum ${this.maxImages} images allowed`, 'warning');
                    return;
                }

                this.selectedImages.push({
                    id: imageId,
                    url: item.dataset.imageUrl,
                    thumbnailUrl: item.dataset.thumbnailUrl,
                    name: item.dataset.imageName
                });
                item.classList.add('selected');
            }

            this.renderSelectedImages();
            this.updateTransformButton();
            
            const thumbnails = document.querySelectorAll('.venue-thumbnail');
            thumbnails.forEach(t => {
                if (parseInt(t.dataset.imageId) === imageId) {
                    if (existingIndex >= 0) {
                        t.classList.remove('selected');
                    } else {
                        t.classList.add('selected');
                    }
                }
            });
        }

        updateTransformButton() {
            const btn = document.getElementById('transformBtn');
            const hasImages = this.selectedImages.length > 0;
            
            // UPDATED: Single field validation per mode
            let hasRequiredFields = false;
            if (this.currentMode === 'venue') {
                const theme = document.getElementById('wedding-theme')?.value;
                hasRequiredFields = !!theme;
            } else {
                const pose = document.getElementById('pose-style')?.value;
                hasRequiredFields = !!pose;
            }

            const canTransform = hasImages && hasRequiredFields;

            btn.disabled = !canTransform;

            if (canTransform) {
                btn.className = 'btn btn-primary py-2 w-100';
                const imageText = this.selectedImages.length === 1 ? '1 Image' : `${this.selectedImages.length} Images`;
                btn.innerHTML = `<i class="bi bi-magic me-1"></i> <span>Transform ${imageText}</span>`;
            } else if (!hasImages) {
                btn.className = 'btn btn-secondary py-2 w-100';
                btn.innerHTML = '<i class="bi bi-magic me-1"></i> <span>Select Images First</span>';
            } else {
                btn.className = 'btn btn-secondary py-2 w-100';
                if (this.currentMode === 'venue') {
                    btn.innerHTML = '<i class="bi bi-magic me-1"></i> <span>Select Wedding Style</span>';
                } else {
                    btn.innerHTML = '<i class="bi bi-magic me-1"></i> <span>Select Pose/Action</span>';
                }
            }
        }

        async processImages() {
            if (this.selectedImages.length === 0) {
                this.showAlert('Please select at least one image', 'danger');
                return;
            }

            const formData = this.getFormData();
            
            // UPDATED: Single field validation per mode
            if (this.currentMode === 'venue') {
                if (!formData.wedding_theme) {
                    this.showAlert('Please select wedding style', 'danger');
                    return;
                }
            } else {
                if (!formData.pose_style) {
                    this.showAlert('Please select pose/action', 'danger');
                    return;
                }
            }

            const btn = document.getElementById('transformBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> <span>Starting...</span>';

            try {
                const primaryImageId = this.selectedImages[0].id;
                const referenceImageIds = this.selectedImages.slice(1).map(img => img.id);

                formData.reference_image_ids = referenceImageIds;

                const response = await fetch(`/studio/image/${primaryImageId}/process/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    this.showAlert('AI transformation started! Redirecting...', 'success');
                    
                    setTimeout(() => {
                        window.location.href = '/studio/visualizations/';
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Processing failed');
                }
            } catch (error) {
                console.error('Processing error:', error);
                this.showAlert('Error: ' + error.message, 'danger');
                this.updateTransformButton();
            }
        }

        getFormData() {
            const form = document.getElementById('transformForm');
            const formData = new FormData(form);
            const data = {};

            for (let [key, value] of formData.entries()) {
                if (value && value.trim() !== '') {
                    data[key] = value.trim();
                }
            }

            return data;
        }

        showUploadProgress() {
            document.getElementById('uploadArea').classList.add('d-none');
            document.getElementById('uploadProgress').classList.remove('d-none');
        }

        hideUploadProgress() {
            document.getElementById('uploadArea').classList.remove('d-none');
            document.getElementById('uploadProgress').classList.add('d-none');
        }

        showAlert(message, type) {
            document.querySelectorAll('.studio-alert').forEach(alert => alert.remove());
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed studio-alert`;
            alert.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 350px;';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentElement) alert.remove();
            }, 5000);
        }

        getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                   document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
        }
    }

    window.studioManager = new MultiModeStudio();
    console.log('üéâ Multi-Mode Studio initialized!');
}
</script>
{% endblock %}