{% extends "base.html" %}
{% load static %}

{% block title %}Wedding Studio - Smart Transformations{% endblock %}
{% block css %}
{{ block.super }}
<link rel="canonical" href="{{ request.scheme }}://{{ request.get_host }}{% url 'image_processing:wedding_studio' %}">
<style>
/* Studio Mode Tabs */
.studio-mode-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
}

.studio-mode-tab {
  flex: 1;
  padding: 0.75rem;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
}

.studio-mode-tab:hover {
  border-color: #00F5FF;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.studio-mode-tab.active {
  border-color: #00F5FF;
  background: rgba(0, 245, 255, 0.1);
}

.studio-mode-tab .mode-icon {
  font-size: 1.5rem;
  margin-bottom: 0.25rem;
}

.studio-mode-tab .mode-name {
  font-weight: 600;
  font-size: 0.9rem;
}

/* Selected Images Card */
.selected-images-card {
  max-height: none;
  overflow-y: auto;
}

/* Studio Settings card (first) expands with content */
.studio-card:first-child {
  min-height: 550px;
  height: auto !important;  /* Allow to grow */
}

/* Upload and Selected cards stay fixed height */
.studio-card:nth-child(2),
.studio-card:nth-child(3) {
  height: 550px !important;  /* Fixed height */
  overflow: hidden;
}

.studio-card {
  display: flex;
  flex-direction: column;
}

.studio-card .card-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: auto;
}

/* Image preview area - centered and fills space */
#imagePreview {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 2rem 1.5rem;
}

#imagePreview img {
  border: 3px solid #00F5FF;
  box-shadow: 0 4px 12px rgba(0, 245, 255, 0.3);
  margin-bottom: 1.5rem;
}

/* Upload zone - fill entire card body */
.upload-zone {
  border: 2px dashed #dee2e6;
  border-radius: 15px;
  transition: all 0.3s ease;
  cursor: pointer;
  background: rgba(248, 249, 250, 0.5);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 2rem;
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  margin: 1rem;
}

.upload-zone:hover,
.upload-zone.dragover {
  border-color: #00F5FF;
  background-color: rgba(0, 245, 255, 0.05);
  transform: scale(1.005);
}

/* Mobile: Better alignment and spacing */
@media (max-width: 768px) {
  /* All cards get natural height on mobile */
  .studio-card:first-child {
    min-height: auto;
  }
  
  .studio-card:nth-child(2),
  .studio-card:nth-child(3) {
    height: auto !important;
    overflow: visible !important;
  }
  
  .studio-card {
    height: auto;
  }
  
  .studio-card .card-body {
    overflow: visible;
  }
  
  /* Upload area relative positioning on mobile */
  #uploadArea {
    position: relative !important;
    min-height: 400px;
  }
  
  #imagePreview {
    position: relative !important;
    min-height: 350px;
    padding: 1.5rem 1rem;
  }
  
  #imagePreview img {
    max-height: 300px !important;
    margin-bottom: 1rem;
  }
  
  #imagePreview .btn {
    width: 100%;
    max-width: 300px;
    margin: 0.25rem 0 !important;
  }
  
  #clearPreviewBtn {
    top: 5px !important;
    right: 5px !important;
  }
  
  .upload-zone {
    position: relative !important;
    min-height: 350px;
    margin: 0 !important;
    width: 100% !important;
  }
  
  .selected-image-item {
    max-width: 200px;
  }
}

@media (max-width: 480px) {
  #imagePreview img {
    max-height: 250px !important;
  }
  
  .selected-image-item {
    max-width: 230px;
  }
  
  .upload-zone {
    min-height: 300px;
  }
  
  #uploadArea {
    min-height: 300px;
  }
}

.selected-image-item {
  position: relative;
  width: 100%;
  aspect-ratio: 1;
  border-radius: 8px;
  overflow: hidden;
  border: 3px solid #00F5FF;
  cursor: move;
  margin-bottom: 1rem;
  max-width: 140px;  /* Increased from 125px */
  margin-left: auto;
  margin-right: auto;
  transition: transform 0.2s ease;
}

.selected-image-item:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0, 245, 255, 0.3);
}

.selected-image-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.selected-image-item .remove-btn {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 24px;  /* Increased from 18px */
  height: 24px;
  background: #dc3545;
  color: white;
  border-radius: 50%;
  border: none;
  font-size: 12px;  /* Increased from 10px */
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 2;
  transition: transform 0.2s ease;
}

.selected-image-item .remove-btn:hover {
  transform: scale(1.15);
  background: #bb2d3b;
}

.selected-image-item .order-badge {
  position: absolute;
  bottom: 4px;
  left: 4px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  border-radius: 50%;
  width: 24px;  /* Increased from 18px */
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;  /* Increased from 10px */
  font-weight: bold;
  z-index: 2;
  border: 2px solid #00F5FF;
}

/* Mobile: Make images MUCH bigger */
@media (max-width: 768px) {
  .selected-image-item {
    max-width: 180px;  /* Reduced from 200px (10% smaller) */
    margin-bottom: 1.5rem;
    border-width: 4px;
  }
  
  .selected-image-item .remove-btn {
    width: 32px;  /* Even bigger buttons on mobile */
    height: 32px;
    font-size: 16px;
    top: 6px;
    right: 6px;
  }
  
  .selected-image-item .order-badge {
    width: 32px;
    height: 32px;
    font-size: 16px;
    bottom: 6px;
    left: 6px;
  }
}

/* Small mobile: Nearly full width */
@media (max-width: 480px) {
  .selected-image-item {
    max-width: 215px;  /* Reduced from 240px (10% smaller) */
  }
}

.selected-images-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: #6c757d;
  font-size: 0.9rem;
  text-align: center;
}

/* Favorite uploads section */
.favorite-uploads-section {
  padding: 1rem;
  background: #fff;
  border-radius: 8px;
  border: 1px solid #dee2e6;
}

.favorite-upload-item {
  position: relative;
  width: 100px;
  height: 100px;
  border-radius: 4px;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s ease;
}

.favorite-upload-item:hover {
  border-color: #00F5FF;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.favorite-upload-item.selected {
  border-color: #28a745;
  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
}

.favorite-upload-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.favorite-upload-item .star-badge {
  position: absolute;
  top: 4px;
  left: 4px;
  background: rgba(255, 193, 7, 0.9);
  color: white;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
}

/* Mode-specific field groups */
.mode-fields {
  display: none;
}

.mode-fields.active {
  display: block;
}

/* Venue thumbnail styling */
.venue-thumbnail {
  transition: all 0.2s ease;
  border: 2px solid transparent !important;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.venue-thumbnail:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  border-color: #00F5FF !important;
}

.venue-thumbnail.selected {
  border-color: #28a745 !important;
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.venue-thumbnail.selected::after {
  content: '‚úì';
  position: absolute;
  top: 4px;
  right: 4px;
  background: #28a745;
  color: white;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
}

/* Mobile: Make recent images MUCH bigger - match favorite uploads */
@media (max-width: 768px) {
  .venue-thumbnail {
    height: 120px !important;
  }
}

@media (max-width: 480px) {
  .venue-thumbnail {
    height: 140px !important;
  }
}

.object-fit-cover {
  object-fit: cover;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3" style="max-width: 1400px;">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h1 class="h2 mb-2">Wedding Studio</h1>
      <p class="text-muted mb-0">Transform spaces or create portraits with AI</p>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="row g-4">
    
    <!-- Left: Studio Controls -->
    <div class="col-xl-3 col-lg-3 col-md-12">
      <div class="card shadow-sm studio-card">
        <div class="card-header py-2 bg-primary text-white">
          <h6 class="mb-0 fw-bold">üé® Studio Settings</h6>
        </div>
        <div class="card-body p-3">
          <form id="transformForm">
            {% csrf_token %}
            
            <!-- Studio Mode Selection -->
            <div class="mb-3">
              <label class="form-label fw-bold small">Studio Mode</label>
              <div class="studio-mode-tabs">
                <div class="studio-mode-tab active" data-mode="venue">
                  <div class="mode-icon">üèõÔ∏è</div>
                  <div class="mode-name">Venue</div>
                </div>
                <div class="studio-mode-tab" data-mode="portrait_wedding">
                  <div class="mode-icon">üë∞</div>
                  <div class="mode-name">Wedding</div>
                </div>
                <div class="studio-mode-tab" data-mode="portrait_engagement">
                  <div class="mode-icon">üíï</div>
                  <div class="mode-name">Engagement</div>
                </div>
              </div>
              <input type="hidden" id="studio-mode" name="studio_mode" value="venue">
            </div>

            <!-- VENUE MODE FIELDS -->
            <div class="mode-fields active" id="venue-fields">
              <div class="mb-3">
                <label for="wedding-theme" class="form-label fw-bold small">Wedding Style <span class="text-danger">*</span></label>
                <select class="form-select" id="wedding-theme" name="wedding_theme">
                  <option value="">Choose style...</option>
                  {% for value, label in wedding_themes %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
                <small class="form-text text-muted">Required: Pick your wedding style</small>
              </div>
              
              <div class="mb-3">
                <label for="space-type" class="form-label fw-bold small">Space Type</label>
                <select class="form-select" id="space-type" name="space_type">
                  <option value="">Choose space (optional)...</option>
                  {% for value, label in space_types %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
                <small class="form-text text-muted">Optional: Specify the type of space to decorate</small>
              </div>
            </div>

            <!-- ENGAGEMENT PORTRAIT MODE FIELDS -->
            <div class="mode-fields" id="engagement-fields">
              <div class="mb-3">
                <label for="engagement-activity" class="form-label fw-bold small">Activity/Pose <span class="text-danger">*</span></label>
                <select class="form-select" id="engagement-activity" name="engagement_activity">
                  <option value="">Choose activity...</option>
                  {% for value, label in engagement_activities %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
                <small class="form-text text-muted">Required: What are they doing together?</small>
              </div>

              <div class="mb-3">
                <label for="engagement-setting" class="form-label fw-bold small">Setting</label>
                <select class="form-select" id="engagement-setting" name="engagement_setting">
                  <option value="">Choose setting (optional)...</option>
                  {% for value, label in engagement_settings %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
                <small class="form-text text-muted">Optional: Where should the photo be taken</small>
              </div>
            </div>

            <!-- WEDDING PORTRAIT MODE FIELDS -->
            <div class="mode-fields" id="wedding-fields">
              <div class="mb-3">
                <label for="wedding-moment" class="form-label fw-bold small">Moment/Scene <span class="text-danger">*</span></label>
                <select class="form-select" id="wedding-moment" name="wedding_moment">
                  <option value="">Choose moment...</option>
                  {% for value, label in wedding_moments %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
                <small class="form-text text-muted">Required: Which moment should be captured?</small>
              </div>

              <div class="mb-3">
                <label for="wedding-setting" class="form-label fw-bold small">Setting</label>
                <select class="form-select" id="wedding-setting" name="wedding_setting">
                  <option value="">Choose setting (optional)...</option>
                  {% for value, label in wedding_settings %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
                <small class="form-text text-muted">Optional: Location for this moment</small>
              </div>
            </div>

            <!-- Optional Details -->
            <div class="border-top pt-3 mt-3">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h6 class="mb-0 text-muted">More Options</h6>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleOptional">
                  <i class="bi bi-chevron-down" id="toggleIcon"></i>
                </button>
              </div>
              
              <div id="optionalFields" class="d-none">
                <!-- Portrait-Only Optional Fields (Engagement & Wedding) -->
                <div class="portrait-optional-fields d-none">
                  <div class="mb-3">
                    <label for="attire-style" class="form-label small">Attire Style</label>
                    <select class="form-select form-select-sm" id="attire-style" name="attire_style">
                      <option value="">Choose attire (optional)...</option>
                      {% for value, label in attire_styles %}
                        <option value="{{ value }}">{{ label }}</option>
                      {% endfor %}
                    </select>
                    <small class="form-text text-muted">Optional: Style of clothing for the couple</small>
                  </div>

                  <div class="mb-3">
                    <label for="composition" class="form-label small">Composition</label>
                    <select class="form-select form-select-sm" id="composition" name="composition">
                      <option value="">Automatic (optional)...</option>
                      {% for value, label in composition_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                      {% endfor %}
                    </select>
                    <small class="form-text text-muted">Optional: Camera angle and framing style</small>
                  </div>

                  <div class="mb-3">
                    <label for="emotional-tone" class="form-label small">Emotional Tone</label>
                    <select class="form-select form-select-sm" id="emotional-tone" name="emotional_tone">
                      <option value="">Automatic (optional)...</option>
                      {% for value, label in emotional_tone_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                      {% endfor %}
                    </select>
                    <small class="form-text text-muted">Optional: Overall mood and feeling of the photo</small>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="season" class="form-label small">Season</label>
                  <select class="form-select form-select-sm" id="season" name="season">
                    {% for value, label in season_choices %}
                      <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                  <small class="form-text text-muted">Optional: Time of year for seasonal elements</small>
                </div>

                <div class="mb-3">
                  <label for="lighting" class="form-label small">Lighting</label>
                  <select class="form-select form-select-sm" id="lighting" name="lighting_mood">
                    {% for value, label in lighting_choices %}
                      <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                  <small class="form-text text-muted">Optional: Lighting style and atmosphere</small>
                </div>

                <div class="mb-3">
                  <label for="color-scheme" class="form-label small">Colors</label>
                  <select class="form-select form-select-sm" id="color-scheme" name="color_scheme">
                    <option value="">Theme default</option>
                    {% for value, label in color_schemes %}
                      <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                  <small class="form-text text-muted">Optional: Color palette for the design</small>
                </div>

                <div class="mb-3">
                  <label for="user-instructions" class="form-label small">Additional Instructions</label>
                  <textarea class="form-control form-control-sm" id="user-instructions" name="user_instructions" 
                            rows="3" placeholder="Any specific requests..."></textarea>
                  <small class="form-text text-muted">Optional: Any other details or preferences</small>
                </div>
              </div>
            </div>
            
            <div class="d-grid">
              <button type="submit" class="btn btn-secondary py-2" id="transformBtn" disabled>
                <i class="bi bi-magic me-1"></i> <span>Select Images First</span>
              </button>
            </div>
            
            {% if usage_data %}
            <div class="text-center mt-2">
              <small class="text-muted">
                {{ usage_data.remaining }} of {{ usage_data.limit }} remaining
              </small>
            </div>
            {% endif %}
          </form>
        </div>
      </div>
    </div>

    <!-- Center: Upload Area -->
    <div class="col-xl-6 col-lg-5 col-md-12">
      <div class="card shadow-sm studio-card">
        <div class="card-body p-4 position-relative">
          
          <!-- Upload Area -->
          <div id="uploadArea" class="position-absolute" style="top: 0; left: 0; right: 0; bottom: 0;">
            <!-- Image Preview (shown when images selected) -->
            <div id="imagePreview" class="d-none position-relative">
              <!-- X button to clear preview -->
              <button type="button" class="btn-close position-absolute" id="clearPreviewBtn" 
                      style="top: 10px; right: 10px; z-index: 10; background-color: white; border-radius: 50%; padding: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"
                      aria-label="Remove image"></button>
              
              <div class="text-center mb-3 position-relative">
                <img id="previewImage" src="" alt="Selected image" class="img-fluid rounded shadow-sm" style="max-height: 350px; max-width: 100%; object-fit: contain;">
              </div>
              <div class="text-center">
                <button type="button" class="btn btn-outline-primary upload-btn" id="uploadNewBtn">
                  <i class="bi bi-cloud-upload me-2"></i> Upload New
                </button>
                <button type="button" class="btn btn-outline-secondary ms-2 d-md-none camera-btn" id="cameraNewBtn">
                  <i class="bi bi-camera me-2"></i> Camera
                </button>
              </div>
            </div>
            
            <!-- Upload Zone (shown when no images) -->
            <div class="upload-zone" id="dropZone">
              <div class="mb-4">
                <button type="button" class="btn btn-primary btn-lg upload-btn" id="uploadBtn">
                  <i class="bi bi-cloud-upload me-2"></i> Upload Images
                </button>
                <button type="button" class="btn btn-outline-primary btn-lg ms-3 d-md-none camera-btn" id="cameraBtn">
                  <i class="bi bi-camera me-2"></i> Take Photo
                </button>
              </div>
              
              <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.webp,image/jpeg,image/png,image/webp" multiple class="d-none">
              <input type="file" id="cameraInput" accept=".jpg,.jpeg,.png,.webp,image/jpeg,image/png,image/webp" capture="environment" class="d-none">
              
              <i class="bi bi-cloud-upload text-primary mb-3" style="font-size: 4rem;"></i>
              <h4 class="mb-3" id="uploadTitle">Upload Your Images</h4>
              <p class="text-muted mb-3" id="uploadDescription">Select up to 3 images (venue photos, selfies, references)</p>
              <p class="text-muted small mb-0"><strong>JPG, PNG, WebP</strong> ‚Ä¢ Max 10MB each</p>
            </div>
          </div>

          <!-- Upload Progress -->
          <div id="uploadProgress" class="text-center w-100 d-none">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
            <h5 id="uploadProgressText">Uploading...</h5>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Selected Images -->
    <div class="col-xl-3 col-lg-4 col-md-12">
      <div class="card shadow-sm selected-images-card studio-card">
        <div class="card-header py-2 bg-success text-white">
          <h6 class="mb-0 fw-bold">
            <i class="bi bi-images me-1"></i>
            Selected (<span id="selectedCount">0</span>/3)
          </h6>
        </div>
        <div class="card-body p-3" id="selectedImagesContainer">
          <div class="selected-images-placeholder">
            <i class="bi bi-images mb-2" style="font-size: 3rem;"></i>
            <p class="mb-0">No images selected</p>
            <small class="text-muted">Select 1-3 images</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Favorite Uploads Section -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header py-2 bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold">‚≠ê Favorite Uploads - Quick Add</h6>
            <small class="text-muted">Click to add to selection</small>
          </div>
        </div>
        <div class="card-body p-3">
          <div id="favoriteUploadsContainer" class="d-flex gap-2 flex-wrap">
            <div class="text-muted small">
              <i class="bi bi-star me-1"></i>Star images from Recent Images below for quick access
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header py-2 bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold">üì∏ Recent Images</h6>
            <a href="{% url 'image_processing:image_gallery' %}" class="btn btn-sm btn-outline-primary">
              View All
            </a>
          </div>
        </div>
        <div class="card-body p-3">
          {% if recent_images %}
            <div class="row g-2" id="recentImagesContainer">
              {% for image in recent_images|slice:":12" %}
                <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xl-1">
                  <div class="venue-thumbnail border rounded overflow-hidden position-relative" 
                       data-image-id="{{ image.id }}"
                       data-image-url="{{ image.image.url }}"
                       data-thumbnail-url="{% if image.thumbnail %}{{ image.thumbnail.url }}{% else %}{{ image.image.url }}{% endif %}"
                       data-image-name="{{ image.original_filename }}"
                       style="cursor: pointer; aspect-ratio: 1; height: 100px;">
                    <img src="{% if image.thumbnail %}{{ image.thumbnail.url }}{% else %}{{ image.image.url }}{% endif %}" 
                         class="w-100 h-100 object-fit-cover" 
                         alt="{{ image.original_filename }}">
                    <div class="position-absolute top-0 start-0 m-1">
                      {% include 'image_processing/components/favorite_star.html' with user_image=image %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="bi bi-images text-muted fs-4"></i>
              <p class="text-muted mb-0 mt-2">No uploads yet</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeMultiModeStudio();
});

function initializeMultiModeStudio() {
    console.log('üé¨ Initializing Multi-Mode Studio...');
    
    class MultiModeStudio {
        constructor() {
            this.selectedImages = [];
            this.favoriteUploads = [];
            this.currentMode = 'venue';
            this.maxImages = 3;
            this.allowedFormats = ['jpg', 'jpeg', 'png', 'webp'];
            this.init();
        }

        init() {
            this.setupModeToggle();
            this.setupUploadButtons();
            this.setupFileInputs();
            this.setupDropZone();
            this.setupThumbnails();
            this.setupForm();
            this.setupOptionalFields();
            this.loadFavoriteUploads();
            this.updateUploadText();
            
            // Handle URL parameters (job_id or image_id)
            this.handleURLParameters();
            
            document.addEventListener('favoriteUploadChanged', (e) => {
                console.log('‚≠ê Favorite upload changed event received:', e.detail);
                this.loadFavoriteUploads();
            });
            
            console.log('‚úÖ Multi-Mode Studio ready!');
        }

        async handleURLParameters() {
            const params = new URLSearchParams(window.location.search);
            const jobId = params.get('job_id');
            const imageId = params.get('image_id');
            
            if (jobId) {
                // Load job details and auto-select images + settings
                console.log('üì¶ Loading job details:', jobId);
                await this.loadJobDetails(jobId);
            } else if (imageId) {
                // Just auto-select single image
                console.log('üñºÔ∏è Auto-selecting image:', imageId);
                await this.autoSelectImage(imageId);
            }
        }

        async loadJobDetails(jobId) {
            try {
                const response = await fetch(`/studio/job/${jobId}/details/`);
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Job details loaded:', data);
                    
                    // Check if any images are missing
                    if (data.images_missing > 0) {
                        console.warn(`‚ö†Ô∏è ${data.images_missing} image(s) from this job have been deleted`);
                    }
                    
                    // Auto-select all AVAILABLE images from the job (using full image data)
                    if (data.images && data.images.length > 0) {
                        for (const imageData of data.images) {
                            // Check if already selected
                            if (!this.selectedImages.find(img => img.id === imageData.id)) {
                                // Check max images
                                if (this.selectedImages.length < this.maxImages) {
                                    this.selectedImages.push({
                                        id: imageData.id,
                                        url: imageData.url,
                                        thumbnailUrl: imageData.thumbnailUrl,
                                        name: imageData.name
                                    });
                                    console.log('‚úÖ Auto-selected image:', imageData.name);
                                }
                            }
                        }
                        
                        // Re-render the selected images display
                        this.renderSelectedImages();
                        this.updateTransformButton();
                        
                        // Sync thumbnail selection states in gallery
                        this.syncThumbnailStates();
                    } else {
                        console.warn('‚ö†Ô∏è No images available for this job');
                    }
                    
                    // Pre-fill form settings (always restore settings even if images missing)
                    this.prefillFormSettings(data.settings);
                    
                    // Show appropriate message
                    if (data.warning) {
                        // Some images deleted - show warning
                        this.showNotification(data.warning, 'warning');
                    } else if (data.images_available > 0) {
                        // All images available - show success
                        this.showNotification(
                            `Ready to transform! Settings and ${data.images_available} image(s) loaded. Click "Transform" to continue.`, 
                            'success'
                        );
                    } else {
                        // No images available - show info
                        this.showNotification(
                            'Settings restored, but original images have been deleted. Please select new images.', 
                            'info'
                        );
                    }
                } else {
                    console.error('Failed to load job details:', data.error);
                    this.showNotification('Failed to load previous settings', 'error');
                }
            } catch (error) {
                console.error('Error loading job details:', error);
                this.showNotification('Error loading previous settings', 'error');
            }
        }

        async autoSelectImage(imageId) {
            try {
                // Check if already selected
                if (this.selectedImages.find(img => img.id === parseInt(imageId))) {
                    console.log('Image already selected:', imageId);
                    return;
                }
                
                // Check max images
                if (this.selectedImages.length >= this.maxImages) {
                    console.log('Max images reached');
                    return;
                }
                
                // Fetch image data
                const response = await fetch(`/studio/favorite-uploads/`);
                const favData = await response.json();
                
                // Find the image in favorites or other sources
                let imageData = null;
                for (const fav of favData.favorites) {
                    if (fav.image.id === parseInt(imageId)) {
                        imageData = fav.image;
                        break;
                    }
                }
                
                if (imageData) {
                    this.addImageToSelection(imageData);
                } else {
                    console.log('Image not found in favorites, fetching directly...');
                    // Fallback: try to fetch image details directly if needed
                }
            } catch (error) {
                console.error('Error auto-selecting image:', error);
            }
        }

        syncThumbnailStates() {
            // Mark all thumbnails as selected or unselected based on selectedImages array
            // Use requestAnimationFrame to ensure DOM is ready
            requestAnimationFrame(() => {
                console.log('üîÑ Syncing thumbnail selection states...');
                const thumbnails = document.querySelectorAll('.venue-thumbnail, .favorite-upload-item');
                
                let syncCount = 0;
                thumbnails.forEach(thumbnail => {
                    const imageId = parseInt(thumbnail.dataset.imageId);
                    const isSelected = this.selectedImages.some(img => img.id === imageId);
                    
                    if (isSelected) {
                        if (!thumbnail.classList.contains('selected')) {
                            thumbnail.classList.add('selected');
                            syncCount++;
                        }
                    } else {
                        if (thumbnail.classList.contains('selected')) {
                            thumbnail.classList.remove('selected');
                        }
                    }
                });
                
                console.log(`‚úÖ Thumbnail states synced (${syncCount} thumbnails marked as selected)`);
            });
        }

        switchModeWithoutClearing(mode) {
            console.log('üîÑ Switching to mode (without clearing):', mode);
            
            const modeTabs = document.querySelectorAll('.studio-mode-tab');
            const studioModeInput = document.getElementById('studio-mode');
            const portraitOptionalFields = document.querySelector('.portrait-optional-fields');
            
            // Update active tab
            modeTabs.forEach(tab => {
                if (tab.dataset.mode === mode) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update hidden input
            if (studioModeInput) studioModeInput.value = mode;
            this.currentMode = mode;
            
            // Hide all mode field groups
            document.querySelectorAll('.mode-fields').forEach(f => f.classList.remove('active'));
            
            // Show appropriate fields based on mode
            if (mode === 'venue') {
                document.getElementById('venue-fields').classList.add('active');
                if (portraitOptionalFields) {
                    portraitOptionalFields.classList.add('d-none');
                }
            } else if (mode === 'portrait_engagement') {
                document.getElementById('engagement-fields').classList.add('active');
                if (portraitOptionalFields) {
                    portraitOptionalFields.classList.remove('d-none');
                }
            } else if (mode === 'portrait_wedding') {
                document.getElementById('wedding-fields').classList.add('active');
                if (portraitOptionalFields) {
                    portraitOptionalFields.classList.remove('d-none');
                }
            }
            
            this.updateUploadText();
            // Don't update transform button yet - will do after fields are populated
        }

        prefillFormSettings(settings) {
            console.log('üìù Pre-filling form settings:', settings);
            
            // STEP 1: Switch mode FIRST (manually, without clearing fields)
            if (settings.studio_mode) {
                this.switchModeWithoutClearing(settings.studio_mode);
            }
            
            // STEP 2: Now populate all fields (after mode is set)
            
            // Custom prompt
            if (settings.custom_prompt) {
                const customPromptField = document.getElementById('custom-prompt');
                if (customPromptField) customPromptField.value = settings.custom_prompt;
            }
            
            // Venue settings
            if (settings.wedding_theme) {
                const themeSelect = document.getElementById('wedding-theme');
                if (themeSelect) themeSelect.value = settings.wedding_theme;
            }
            if (settings.space_type) {
                const spaceSelect = document.getElementById('space-type');
                if (spaceSelect) spaceSelect.value = settings.space_type;
            }
            
            // Engagement portrait settings
            if (settings.engagement_activity) {
                const activitySelect = document.getElementById('engagement-activity');
                if (activitySelect) activitySelect.value = settings.engagement_activity;
            }
            if (settings.engagement_setting) {
                const settingSelect = document.getElementById('engagement-setting');
                if (settingSelect) settingSelect.value = settings.engagement_setting;
            }
            
            // Wedding portrait settings
            if (settings.wedding_moment) {
                const momentSelect = document.getElementById('wedding-moment');
                if (momentSelect) {
                    momentSelect.value = settings.wedding_moment;
                    console.log('‚úÖ Set wedding_moment to:', settings.wedding_moment);
                }
            }
            if (settings.wedding_setting) {
                const settingSelect = document.getElementById('wedding-setting');
                if (settingSelect) settingSelect.value = settings.wedding_setting;
            }
            
            // Shared portrait settings
            if (settings.attire_style) {
                const attireSelect = document.getElementById('attire-style');
                if (attireSelect) attireSelect.value = settings.attire_style;
            }
            if (settings.composition) {
                const compositionSelect = document.getElementById('composition');
                if (compositionSelect) compositionSelect.value = settings.composition;
            }
            if (settings.emotional_tone) {
                const emotionalToneSelect = document.getElementById('emotional-tone');
                if (emotionalToneSelect) emotionalToneSelect.value = settings.emotional_tone;
            }
            
            // Shared settings
            if (settings.season) {
                const seasonSelect = document.getElementById('season');
                if (seasonSelect) seasonSelect.value = settings.season;
            }
            if (settings.lighting_mood) {
                const lightingSelect = document.getElementById('lighting');
                if (lightingSelect) lightingSelect.value = settings.lighting_mood;
            }
            if (settings.color_scheme) {
                const colorSchemeSelect = document.getElementById('color-scheme');
                if (colorSchemeSelect) colorSchemeSelect.value = settings.color_scheme;
            }
            if (settings.user_instructions) {
                const instructionsField = document.getElementById('user-instructions');
                if (instructionsField) instructionsField.value = settings.user_instructions;
            }
            
            // STEP 3: Update transform button state now that fields are populated
            this.updateTransformButton();
            
            console.log('‚úÖ All settings restored');
        }

        showNotification(message, type = 'info') {
            const alertTypes = {
                'success': { class: 'alert-success', icon: 'check-circle' },
                'error': { class: 'alert-danger', icon: 'exclamation-triangle' },
                'warning': { class: 'alert-warning', icon: 'exclamation-triangle' },
                'info': { class: 'alert-info', icon: 'info-circle' }
            };
            
            const alertConfig = alertTypes[type] || alertTypes['info'];
            
            const alert = document.createElement('div');
            alert.className = `alert ${alertConfig.class} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 350px;';
            alert.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-${alertConfig.icon}-fill me-2"></i>
                    <div>${message}</div>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentElement) alert.remove();
            }, 5000);
        }

        validateFileFormat(file) {
            const fileName = file.name.toLowerCase();
            const fileExt = fileName.split('.').pop();
            
            if (!this.allowedFormats.includes(fileExt)) {
                return {
                    valid: false,
                    error: `Invalid format ".${fileExt}". Please upload JPG, PNG, or WebP images only.`
                };
            }
            
            const validMimeTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validMimeTypes.includes(file.type)) {
                return {
                    valid: false,
                    error: `Invalid file type. Please upload JPG, PNG, or WebP images only.`
                };
            }
            
            return { valid: true };
        }

        setupModeToggle() {
            const modeTabs = document.querySelectorAll('.studio-mode-tab');
            const studioModeInput = document.getElementById('studio-mode');
            const portraitOptionalFields = document.querySelector('.portrait-optional-fields');

            modeTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const mode = tab.dataset.mode;
                    
                    // Update active tab
                    modeTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update hidden input
                    studioModeInput.value = mode;
                    this.currentMode = mode;
                    
                    // Clear all mode-specific fields when switching
                    this.clearModeFields();
                    
                    // Hide all mode field groups
                    document.querySelectorAll('.mode-fields').forEach(f => f.classList.remove('active'));
                    
                    // Show appropriate fields based on mode
                    if (mode === 'venue') {
                        document.getElementById('venue-fields').classList.add('active');
                        if (portraitOptionalFields) {
                            portraitOptionalFields.classList.add('d-none');
                        }
                    } else if (mode === 'portrait_engagement') {
                        document.getElementById('engagement-fields').classList.add('active');
                        if (portraitOptionalFields) {
                            portraitOptionalFields.classList.remove('d-none');
                        }
                    } else if (mode === 'portrait_wedding') {
                        document.getElementById('wedding-fields').classList.add('active');
                        if (portraitOptionalFields) {
                            portraitOptionalFields.classList.remove('d-none');
                        }
                    }
                    
                    this.updateUploadText();
                    this.updateTransformButton();
                    
                    console.log('üîÑ Switched to mode:', mode);
                });
            });
        }

        clearModeFields() {
            // Clear venue fields
            const weddingTheme = document.getElementById('wedding-theme');
            const spaceType = document.getElementById('space-type');
            if (weddingTheme) weddingTheme.value = '';
            if (spaceType) spaceType.value = '';
            
            // Clear engagement fields
            const engagementActivity = document.getElementById('engagement-activity');
            const engagementSetting = document.getElementById('engagement-setting');
            if (engagementActivity) engagementActivity.value = '';
            if (engagementSetting) engagementSetting.value = '';
            
            // Clear wedding portrait fields
            const weddingMoment = document.getElementById('wedding-moment');
            const weddingSetting = document.getElementById('wedding-setting');
            if (weddingMoment) weddingMoment.value = '';
            if (weddingSetting) weddingSetting.value = '';
            
            // Clear shared portrait fields (keep these across portrait modes if desired, or clear)
            const attireStyle = document.getElementById('attire-style');
            const composition = document.getElementById('composition');
            const emotionalTone = document.getElementById('emotional-tone');
            if (attireStyle) attireStyle.value = '';
            if (composition) composition.value = '';
            if (emotionalTone) emotionalTone.value = '';
            
            // Optional: Keep season, lighting, color_scheme, user_instructions across modes
            // If you want to clear these too, uncomment:
            // const season = document.getElementById('season');
            // const lighting = document.getElementById('lighting');
            // const colorScheme = document.getElementById('color-scheme');
            // const userInstructions = document.getElementById('user-instructions');
            // if (season) season.value = '';
            // if (lighting) lighting.value = '';
            // if (colorScheme) colorScheme.value = '';
            // if (userInstructions) userInstructions.value = '';
        }

        updateUploadText() {
            const title = document.getElementById('uploadTitle');
            const description = document.getElementById('uploadDescription');
            
            if (this.currentMode === 'venue') {
                title.textContent = 'Upload Your Images';
                description.textContent = 'Select up to 3 images (venue, flower bouquet, design references, etc.)';
            } else if (this.currentMode === 'portrait_engagement') {
                title.textContent = 'Upload Your Images';
                description.textContent = 'Select up to 3 images (selfies, clothing, pet, location reference, etc.)';
            } else if (this.currentMode === 'portrait_wedding') {
                title.textContent = 'Upload Your Images';
                description.textContent = 'Select up to 3 images (selfies, dress, tux, location reference, etc.)';
            }
        }

        setupUploadButtons() {
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadNewBtn = document.getElementById('uploadNewBtn');
            const cameraBtn = document.getElementById('cameraBtn');
            const cameraNewBtn = document.getElementById('cameraNewBtn');
            const clearPreviewBtn = document.getElementById('clearPreviewBtn');
            const fileInput = document.getElementById('fileInput');
            const cameraInput = document.getElementById('cameraInput');

            if (uploadBtn) {
                uploadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    fileInput.click();
                });
            }

            if (uploadNewBtn) {
                uploadNewBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    fileInput.click();
                });
            }

            if (cameraBtn) {
                cameraBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    cameraInput.click();
                });
            }

            if (cameraNewBtn) {
                cameraNewBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    cameraInput.click();
                });
            }

            if (clearPreviewBtn) {
                clearPreviewBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Just hide preview and show upload zone
                    // DON'T clear selectedImages array
                    const imagePreview = document.getElementById('imagePreview');
                    const dropZone = document.getElementById('dropZone');
                    
                    if (imagePreview && dropZone) {
                        imagePreview.classList.add('d-none');
                        dropZone.classList.remove('d-none');
                    }
                });
            }
        }

        setupFileInputs() {
            const fileInput = document.getElementById('fileInput');
            const cameraInput = document.getElementById('cameraInput');

            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    this.handleMultipleFileUpload(Array.from(e.target.files));
                });
            }

            if (cameraInput) {
                cameraInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleMultipleFileUpload(Array.from(e.target.files));
                    }
                });
            }
        }

        setupDropZone() {
            const dropZone = document.getElementById('dropZone');

            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });

                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                    if (files.length > 0) {
                        this.handleMultipleFileUpload(files);
                    }
                });
            }
        }

        async handleMultipleFileUpload(files) {
            const remainingSlots = this.maxImages - this.selectedImages.length;
            
            if (remainingSlots <= 0) {
                this.showAlert(`Maximum ${this.maxImages} images allowed`, 'warning');
                return;
            }

            const invalidFiles = [];
            const validFiles = [];
            
            for (const file of files) {
                const validation = this.validateFileFormat(file);
                if (validation.valid) {
                    validFiles.push(file);
                } else {
                    invalidFiles.push({ name: file.name, error: validation.error });
                }
            }
            
            if (invalidFiles.length > 0) {
                const errorMsg = invalidFiles.length === 1 
                    ? invalidFiles[0].error 
                    : `${invalidFiles.length} files have invalid formats. Please upload JPG, PNG, or WebP only.`;
                this.showAlert(errorMsg, 'danger');
                
                if (validFiles.length === 0) {
                    return;
                }
            }

            const filesToUpload = validFiles.slice(0, remainingSlots);
            
            if (validFiles.length > remainingSlots) {
                this.showAlert(`Only uploading ${remainingSlots} of ${validFiles.length} images (max ${this.maxImages})`, 'warning');
            }

            this.showUploadProgress();

            for (const file of filesToUpload) {
                await this.uploadSingleFile(file);
            }

            this.hideUploadProgress();
            this.renderSelectedImages();
            this.updateTransformButton();
        }

        async uploadSingleFile(file) {
            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('csrfmiddlewaretoken', this.getCSRFToken());

                const response = await fetch('/studio/upload/', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                const data = await response.json();

                if (data.success) {
                    this.selectedImages.push({
                        id: data.image_id,
                        url: data.image_url,
                        thumbnailUrl: data.thumbnail_url || data.image_url,
                        name: data.image_name
                    });
                    
                    this.addToRecentImages(data);
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                this.showAlert('Upload failed: ' + error.message, 'danger');
            }
        }

        renderSelectedImages() {
            const container = document.getElementById('selectedImagesContainer');
            const countEl = document.getElementById('selectedCount');
            const imagePreview = document.getElementById('imagePreview');
            const dropZone = document.getElementById('dropZone');
            const previewImage = document.getElementById('previewImage');
            
            if (!container) return;

            countEl.textContent = this.selectedImages.length;

            // Update main preview area
            if (this.selectedImages.length > 0) {
                // Show most recent image in main preview
                const mostRecent = this.selectedImages[this.selectedImages.length - 1];
                previewImage.src = mostRecent.url;
                imagePreview.classList.remove('d-none');
                dropZone.classList.add('d-none');
            } else {
                // Show upload zone
                imagePreview.classList.add('d-none');
                dropZone.classList.remove('d-none');
            }

            if (this.selectedImages.length === 0) {
                container.innerHTML = `
                    <div class="selected-images-placeholder">
                        <i class="bi bi-images mb-2" style="font-size: 3rem;"></i>
                        <p class="mb-0">No images selected</p>
                        <small class="text-muted">Select 1-3 images</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            this.selectedImages.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = 'selected-image-item';
                item.dataset.imageId = img.id;
                item.innerHTML = `
                    <img src="${img.thumbnailUrl}" alt="${img.name}">
                    <button class="remove-btn" data-index="${index}">√ó</button>
                    <div class="order-badge">${index + 1}</div>
                `;

                const removeBtn = item.querySelector('.remove-btn');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.removeImage(index);
                });

                container.appendChild(item);
            });
        }

        removeImage(index) {
            this.selectedImages.splice(index, 1);
            this.renderSelectedImages();
            this.updateTransformButton();
            
            const thumbnails = document.querySelectorAll('.venue-thumbnail');
            thumbnails.forEach(t => {
                const imageId = parseInt(t.dataset.imageId);
                if (!this.selectedImages.find(img => img.id === imageId)) {
                    t.classList.remove('selected');
                }
            });
        }

        setupThumbnails() {
            document.addEventListener('click', (e) => {
                const thumbnail = e.target.closest('.venue-thumbnail');
                if (thumbnail && !e.target.closest('.favorite-star-btn')) {
                    this.toggleThumbnailSelection(thumbnail);
                }
            });
        }

        toggleThumbnailSelection(thumbnail) {
            const imageId = parseInt(thumbnail.dataset.imageId);
            const imageUrl = thumbnail.dataset.imageUrl;
            const thumbnailUrl = thumbnail.dataset.thumbnailUrl;
            const imageName = thumbnail.dataset.imageName;

            const existingIndex = this.selectedImages.findIndex(img => img.id === imageId);

            if (existingIndex >= 0) {
                this.selectedImages.splice(existingIndex, 1);
                thumbnail.classList.remove('selected');
            } else {
                if (this.selectedImages.length >= this.maxImages) {
                    this.showAlert(`Maximum ${this.maxImages} images allowed`, 'warning');
                    return;
                }

                this.selectedImages.push({
                    id: imageId,
                    url: imageUrl,
                    thumbnailUrl: thumbnailUrl,
                    name: imageName
                });
                thumbnail.classList.add('selected');
            }

            this.renderSelectedImages();
            this.updateTransformButton();
        }

        addToRecentImages(data) {
            const container = document.getElementById('recentImagesContainer');
            if (!container) return;

            const div = document.createElement('div');
            div.className = 'col-6 col-sm-4 col-md-3 col-lg-2 col-xl-1';
            div.innerHTML = `
                <div class="venue-thumbnail border rounded overflow-hidden position-relative" 
                     data-image-id="${data.image_id}"
                     data-image-url="${data.image_url}"
                     data-thumbnail-url="${data.thumbnail_url || data.image_url}"
                     data-image-name="${data.image_name}"
                     style="cursor: pointer; aspect-ratio: 1; height: 100px;">
                    <img src="${data.thumbnail_url || data.image_url}" 
                         class="w-100 h-100 object-fit-cover" 
                         alt="${data.image_name}">
                    <div class="position-absolute top-0 start-0 m-1">
                        <button type="button" 
                                class="favorite-star-btn not-starred"
                                data-user-image-id="${data.image_id}"
                                data-is-starred="false"
                                title="Add to quick access">
                          <i class="bi bi-star"></i>
                        </button>
                    </div>
                </div>
            `;

            container.insertBefore(div, container.firstChild);

            const thumbs = container.querySelectorAll('.col-6, .col-sm-4, .col-md-3, .col-lg-2, .col-xl-1');
            if (thumbs.length > 12) {
                thumbs[thumbs.length - 1].remove();
            }
        }

        setupForm() {
            const form = document.getElementById('transformForm');
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.processImages();
                });
            }

            // Listen to all required fields for all modes
            const requiredFields = ['wedding-theme', 'engagement-activity', 'wedding-moment'];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', () => this.updateTransformButton());
                }
            });
        }

        setupOptionalFields() {
            const toggleBtn = document.getElementById('toggleOptional');
            const optionalFields = document.getElementById('optionalFields');
            const toggleIcon = document.getElementById('toggleIcon');

            if (toggleBtn && optionalFields && toggleIcon) {
                toggleBtn.addEventListener('click', () => {
                    const isHidden = optionalFields.classList.contains('d-none');
                    if (isHidden) {
                        optionalFields.classList.remove('d-none');
                        toggleIcon.className = 'bi bi-chevron-up';
                    } else {
                        optionalFields.classList.add('d-none');
                        toggleIcon.className = 'bi bi-chevron-down';
                    }
                });
            }
        }

        async loadFavoriteUploads() {
            console.log('üî• Loading favorite uploads...');
            try {
                const response = await fetch('/studio/favorite-uploads/', {
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': this.getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    this.favoriteUploads = data.favorites || [];
                    console.log('‚úÖ Loaded favorites:', this.favoriteUploads.length, 'items');
                    this.renderFavoriteUploads();
                } else {
                    console.error('‚ùå Failed to load favorites:', data);
                }
            } catch (error) {
                console.error('‚ùå Error loading favorites:', error);
            }
        }

        renderFavoriteUploads() {
            const container = document.getElementById('favoriteUploadsContainer');
            if (!container) {
                console.error('‚ùå Favorite uploads container not found');
                return;
            }

            console.log('üé® Rendering', this.favoriteUploads.length, 'favorite uploads');

            if (this.favoriteUploads.length === 0) {
                container.innerHTML = `
                    <div class="text-muted small">
                        <i class="bi bi-star me-1"></i>Star images from Recent Images below for quick access
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            this.favoriteUploads.forEach((fav, index) => {
                const isSelected = this.selectedImages.some(img => img.id === fav.image.id);

                const item = document.createElement('div');
                item.className = `favorite-upload-item ${isSelected ? 'selected' : ''}`;
                item.dataset.imageId = fav.image.id;
                item.dataset.imageUrl = fav.image.url;
                item.dataset.thumbnailUrl = fav.image.thumbnail_url;
                item.dataset.imageName = fav.image.name;
                item.title = `${fav.image.name} - Click to ${isSelected ? 'remove' : 'add'}`;

                item.innerHTML = `
                    <img src="${fav.image.thumbnail_url}" alt="${fav.image.name}">
                    <div class="star-badge"><i class="bi bi-star-fill"></i></div>
                `;

                item.addEventListener('click', () => {
                    this.toggleFavoriteUploadSelection(item);
                });

                container.appendChild(item);
                
                console.log(`  ‚úÖ Added favorite #${index + 1}:`, fav.image.name);
            });
            
            console.log('‚úÖ Rendered', this.favoriteUploads.length, 'favorites');
        }

        toggleFavoriteUploadSelection(item) {
            const imageId = parseInt(item.dataset.imageId);
            const existingIndex = this.selectedImages.findIndex(img => img.id === imageId);

            if (existingIndex >= 0) {
                this.selectedImages.splice(existingIndex, 1);
                item.classList.remove('selected');
            } else {
                if (this.selectedImages.length >= this.maxImages) {
                    this.showAlert(`Maximum ${this.maxImages} images allowed`, 'warning');
                    return;
                }

                this.selectedImages.push({
                    id: imageId,
                    url: item.dataset.imageUrl,
                    thumbnailUrl: item.dataset.thumbnailUrl,
                    name: item.dataset.imageName
                });
                item.classList.add('selected');
            }

            this.renderSelectedImages();
            this.updateTransformButton();
            
            const thumbnails = document.querySelectorAll('.venue-thumbnail');
            thumbnails.forEach(t => {
                if (parseInt(t.dataset.imageId) === imageId) {
                    if (existingIndex >= 0) {
                        t.classList.remove('selected');
                    } else {
                        t.classList.add('selected');
                    }
                }
            });
        }

        updateTransformButton() {
            const btn = document.getElementById('transformBtn');
            const hasImages = this.selectedImages.length > 0;
            
            // Check required fields based on mode
            let hasRequiredFields = false;
            if (this.currentMode === 'venue') {
                const theme = document.getElementById('wedding-theme')?.value;
                hasRequiredFields = !!theme;
            } else if (this.currentMode === 'portrait_engagement') {
                const activity = document.getElementById('engagement-activity')?.value;
                hasRequiredFields = !!activity;
            } else if (this.currentMode === 'portrait_wedding') {
                const moment = document.getElementById('wedding-moment')?.value;
                hasRequiredFields = !!moment;
            }

            const canTransform = hasImages && hasRequiredFields;

            btn.disabled = !canTransform;

            if (canTransform) {
                btn.className = 'btn btn-primary py-2 w-100';
                const imageText = this.selectedImages.length === 1 ? '1 Image' : `${this.selectedImages.length} Images`;
                btn.innerHTML = `<i class="bi bi-magic me-1"></i> <span>Transform ${imageText}</span>`;
            } else if (!hasImages) {
                btn.className = 'btn btn-secondary py-2 w-100';
                btn.innerHTML = '<i class="bi bi-magic me-1"></i> <span>Select Images First</span>';
            } else {
                btn.className = 'btn btn-secondary py-2 w-100';
                if (this.currentMode === 'venue') {
                    btn.innerHTML = '<i class="bi bi-magic me-1"></i> <span>Select Wedding Style</span>';
                } else if (this.currentMode === 'portrait_engagement') {
                    btn.innerHTML = '<i class="bi bi-magic me-1"></i> <span>Select Activity/Pose</span>';
                } else if (this.currentMode === 'portrait_wedding') {
                    btn.innerHTML = '<i class="bi bi-magic me-1"></i> <span>Select Moment/Scene</span>';
                }
            }
        }

        async processImages() {
            if (this.selectedImages.length === 0) {
                this.showAlert('Please select at least one image', 'danger');
                return;
            }

            const formData = this.getFormData();
            
            // Validate required fields based on mode
            if (this.currentMode === 'venue') {
                if (!formData.wedding_theme) {
                    this.showAlert('Please select wedding style', 'danger');
                    return;
                }
            } else if (this.currentMode === 'portrait_engagement') {
                if (!formData.engagement_activity) {
                    this.showAlert('Please select activity/pose', 'danger');
                    return;
                }
            } else if (this.currentMode === 'portrait_wedding') {
                if (!formData.wedding_moment) {
                    this.showAlert('Please select moment/scene', 'danger');
                    return;
                }
            }

            const btn = document.getElementById('transformBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> <span>Starting...</span>';

            try {
                const primaryImageId = this.selectedImages[0].id;
                const referenceImageIds = this.selectedImages.slice(1).map(img => img.id);

                formData.reference_image_ids = referenceImageIds;

                const response = await fetch(`/studio/image/${primaryImageId}/process/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    this.showAlert('Transformation started! Redirecting...', 'success');
                    
                    setTimeout(() => {
                        window.location.href = '/studio/visualizations/';
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Processing failed');
                }
            } catch (error) {
                console.error('Processing error:', error);
                this.showAlert('Error: ' + error.message, 'danger');
                this.updateTransformButton();
            }
        }

        getFormData() {
            const form = document.getElementById('transformForm');
            const formData = new FormData(form);
            const data = {};

            for (let [key, value] of formData.entries()) {
                if (value && value.trim() !== '') {
                    data[key] = value.trim();
                }
            }

            return data;
        }

        showUploadProgress() {
            document.getElementById('uploadArea').classList.add('d-none');
            document.getElementById('uploadProgress').classList.remove('d-none');
        }

        hideUploadProgress() {
            document.getElementById('uploadArea').classList.remove('d-none');
            document.getElementById('uploadProgress').classList.add('d-none');
        }

        showAlert(message, type) {
            document.querySelectorAll('.studio-alert').forEach(alert => alert.remove());
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed studio-alert`;
            alert.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 350px;';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentElement) alert.remove();
            }, 5000);
        }

        getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                   document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
        }
    }

    window.studioManager = new MultiModeStudio();
    console.log('üéâ Multi-Mode Studio initialized!');
}
</script>
{% endblock %}