{% extends "base.html" %}
{% load static %}

{% block title %}My Favorites{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-md-6">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'image_processing:wedding_studio' %}">Wedding Studio</a></li>
          <li class="breadcrumb-item active">Favorites</li>
        </ol>
      </nav>
      <h1>❤️ My Favorite Wedding Transformations</h1>
      <p class="text-muted">Your favorite AI-generated wedding venue transformations</p>
    </div>
    <div class="col-md-6 text-end">
      <a href="{% url 'image_processing:wedding_studio' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Create New Transformation
      </a>
    </div>
  </div>

  {% if page_obj %}
    <!-- Favorites Grid -->
    <div class="row">
      {% for favorite in page_obj %}
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4 favorite-item" data-favorite-id="{{ favorite.id }}">
          <div class="card h-100">
            <div class="position-relative">
              <!-- Image Display -->
              <img src="{{ favorite.image_url }}" 
                   class="card-img-top" 
                   alt="Favorite Wedding Transformation"
                   style="height: 200px; object-fit: cover;">
              
              <!-- Type Badge -->
              <div class="position-absolute top-0 start-0 p-2">
                <span class="badge bg-success">
                  <i class="bi bi-magic"></i> Wedding Transformation
                </span>
              </div>
              
              <!-- Favorite Heart -->
              <div class="position-absolute top-0 end-0 p-2">
                {% include 'image_processing/components/favorite_heart.html' with processed_image=favorite.processed_image %}
              </div>

              <!-- NEW: Quick Actions Overlay -->
              <div class="position-absolute bottom-0 end-0 p-2">
                <div class="btn-group-vertical">
                  <div class="dropdown">
                    <button class="btn btn-sm btn-light dropdown-toggle shadow-sm" 
                            type="button" 
                            data-bs-toggle="dropdown"
                            title="Quick Actions">
                      <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li>
                        <a class="dropdown-item" href="{% url 'image_processing:processed_image_detail' favorite.processed_image.pk %}">
                          <i class="bi bi-eye text-success"></i> View Details
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="{{ favorite.processed_image.processed_image.url }}" target="_blank">
                          <i class="bi bi-arrows-fullscreen text-info"></i> Full Size
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="{{ favorite.processed_image.processed_image.url }}" download>
                          <i class="bi bi-download text-primary"></i> Download
                        </a>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <!-- NEW: Redo transformation button -->
                      <li>
                        <a class="dropdown-item redo-transformation-btn" 
                           href="#" 
                           data-job-id="{{ favorite.processed_image.processing_job.id }}"
                           onclick="event.preventDefault(); redoTransformation('{{ favorite.processed_image.processing_job.id }}');">
                          <i class="bi bi-arrow-repeat text-warning"></i> Use These Settings Again
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item add-to-collection-btn" 
                           href="#" 
                           data-processed-image-id="{{ favorite.processed_image.id }}"
                           onclick="event.preventDefault(); addToDefaultCollection('processed', '{{ favorite.processed_image.id }}');">
                          <i class="bi bi-collection text-success"></i> Save to Collection
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card-body">
              <!-- Title -->
              <h6 class="card-title text-truncate">
                {{ favorite.image_title }}
              </h6>
              
              <!-- Wedding Transformation Details -->
              {% with job=favorite.processed_image.processing_job %}
                {% if job.wedding_theme and job.space_type %}
                  <div class="mb-2">
                    <span class="badge bg-primary me-1">{{ job.theme_display }}</span>
                    <span class="badge bg-secondary">{{ job.space_display }}</span>
                  </div>
                {% endif %}
                
                <!-- NEW: Optional parameters display -->
                {% if job.season or job.lighting_mood or job.color_scheme %}
                  <div class="mb-2">
                    {% if job.season %}
                      <span class="badge bg-warning text-dark small">{{ job.season|title }}</span>
                    {% endif %}
                    {% if job.lighting_mood %}
                      <span class="badge bg-secondary small">{{ job.lighting_mood|title }}</span>
                    {% endif %}
                    {% if job.color_scheme %}
                      <span class="badge bg-success small">{{ job.color_scheme|title }}</span>
                    {% endif %}
                  </div>
                {% endif %}
                
                <small class="text-muted">
                  <i class="bi bi-magic"></i> Transformation<br>
                  <i class="bi bi-calendar"></i> Created {{ favorite.processed_image.created_at|date:"M d, Y" }}<br>
                </small>
              {% endwith %}
              
              <small class="text-muted d-block mt-2">
                <i class="bi bi-heart-fill text-danger"></i> Favorited {{ favorite.created_at|timesince }} ago
              </small>
            </div>
            
            <div class="card-footer bg-transparent">
              <div class="row g-1">
                <!-- Link to Processed Image Detail Page -->
                <div class="col-6">
                  <a href="{% url 'image_processing:processed_image_detail' favorite.processed_image.pk %}" 
                     class="btn btn-sm btn-success w-100">
                    <i class="bi bi-eye"></i> View
                  </a>
                </div>
                <!-- NEW: Redo button -->
                <div class="col-6">
                  <button class="btn btn-sm btn-outline-primary w-100 redo-transformation-btn" 
                          data-job-id="{{ favorite.processed_image.processing_job.id }}"
                          onclick="redoTransformation('{{ favorite.processed_image.processing_job.id }}');"
                          title="Use these settings again with a different image">
                    <i class="bi bi-arrow-repeat"></i> Redo
                  </button>
                </div>
              </div>
              <!-- Additional actions row -->
              <div class="row g-1 mt-1">
                <div class="col-4">
                  <a href="{{ favorite.processed_image.processed_image.url }}" 
                     class="btn btn-sm btn-outline-secondary w-100" 
                     target="_blank"
                     title="View full size">
                    <i class="bi bi-arrows-fullscreen"></i>
                  </a>
                </div>
                <div class="col-4">
                  <a href="{{ favorite.processed_image.processed_image.url }}" 
                     class="btn btn-sm btn-outline-primary w-100" 
                     download
                     title="Download image">
                    <i class="bi bi-download"></i>
                  </a>
                </div>
                <div class="col-4">
                  <button class="btn btn-sm btn-outline-success w-100 add-to-collection-btn" 
                          data-processed-image-id="{{ favorite.processed_image.id }}"
                          onclick="addToDefaultCollection('processed', '{{ favorite.processed_image.id }}');"
                          title="Add to collection">
                    <i class="bi bi-collection"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
      <nav aria-label="Favorites pagination" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1">First</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
            </li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

  {% else %}
    <!-- Empty State -->
    <div class="row">
      <div class="col-12">
        <div class="text-center py-5">
          <i class="bi bi-heart text-muted" style="font-size: 4rem;"></i>
          <h3 class="mt-3 text-muted">No Favorites Yet</h3>
          <p class="text-muted">Start creating wedding venue transformations and add your favorites here</p>
          <div class="mt-4">
            <a href="{% url 'image_processing:wedding_studio' %}" class="btn btn-primary btn-lg me-3">
              <i class="bi bi-plus-circle"></i> Create Transformation
            </a>
            <a href="{% url 'image_processing:image_gallery' %}" class="btn btn-outline-secondary btn-lg">
              <i class="bi bi-images"></i> Browse Gallery
            </a>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- Collection Success Toast -->
<div id="collectionToast" class="toast position-fixed top-0 end-0 m-3" style="z-index: 9999;">
  <div class="toast-header">
    <i class="bi bi-collection text-success me-2"></i>
    <strong class="me-auto">Collection</strong>
    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
  </div>
  <div class="toast-body" id="collectionToastBody">
    Image added to collection!
  </div>
</div>

<script>
// NEW: Redo transformation functionality
async function redoTransformation(jobId) {
    try {
        showAlert('Copying settings to studio...', 'info');
        
        const response = await fetch(`/studio/redo-transformation/${jobId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Redirect to studio with pre-filled parameters
            window.location.href = result.redirect_url;
        } else {
            showAlert('Failed to copy settings', 'danger');
        }
    } catch (error) {
        console.error('Redo transformation error:', error);
        showAlert('Error copying settings', 'danger');
    }
}

// Collection helper functions
async function addToDefaultCollection(imageType, imageId) {
    const formData = new FormData();
    formData.append('use_default', 'true');
    
    if (imageType === 'user') {
        formData.append('user_image_id', imageId);
    } else {
        formData.append('processed_image_id', imageId);
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                     document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
    
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    try {
        const response = await fetch('/studio/collections/add/', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showCollectionToast(result.message, 'success');
        } else {
            showCollectionToast(result.message || 'Failed to add to collection', 'warning');
        }
    } catch (error) {
        console.error('Collection error:', error);
        showCollectionToast('Network error', 'error');
    }
}

function showCollectionToast(message, type) {
    const toastEl = document.getElementById('collectionToast');
    const toastBody = document.getElementById('collectionToastBody');
    
    toastBody.textContent = message;
    
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}

function showAlert(message, type) {
    document.querySelectorAll('.temp-alert').forEach(alert => alert.remove());
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed temp-alert`;
    alert.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 350px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentElement) alert.remove();
    }, 5000);
}
</script>
{% endblock %}