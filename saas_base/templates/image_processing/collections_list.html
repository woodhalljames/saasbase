<!-- Collection Management Modals -->
<!-- Add these modals to collections_list.html after the create collection modal -->

<!-- Edit Collection Modal -->
<div class="modal fade" id="editCollectionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Collection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editCollectionForm" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="editCollectionName" class="form-label">Collection Name</label>
            <input type="text" class="form-control" id="editCollectionName" name="name" required maxlength="100">
          </div>
          <div class="mb-3">
            <label for="editCollectionDescription" class="form-label">Description (Optional)</label>
            <textarea class="form-control" id="editCollectionDescription" name="description" rows="3"></textarea>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="editIsPublic" name="is_public">
            <label class="form-check-label" for="editIsPublic">
              Make this collection public (can be shared)
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Collection</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Collection Modal -->
<div class="modal fade" id="deleteCollectionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Collection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the collection <strong id="deleteCollectionName"></strong>?</p>
        <p class="text-danger"><small>This action cannot be undone. All items in this collection will be removed from the collection (but the original images will not be deleted).</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteCollectionBtn">Delete Collection</button>
      </div>
    </div>
  </div>
</div>

<!-- Share Collection Modal -->
<div class="modal fade" id="shareCollectionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Share Collection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Share this collection with others:</p>
        <div class="input-group">
          <input type="text" class="form-control" id="shareCollectionUrl" readonly>
          <button class="btn btn-outline-secondary" type="button" id="copyShareUrl">
            <i class="bi bi-clipboard"></i> Copy
          </button>
        </div>
        <small class="text-muted">Anyone with this link can view your public collection.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
// Collection Management JavaScript
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ”§ Setting up collection management...');
    
    // Edit Collection
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-collection-btn')) {
            e.preventDefault();
            handleEditCollection(e.target);
        }
    });
    
    // Delete Collection
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-collection-btn')) {
            e.preventDefault();
            handleDeleteCollection(e.target);
        }
    });
    
    // Share Collection
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('share-collection-btn')) {
            e.preventDefault();
            handleShareCollection(e.target);
        }
    });
    
    // Edit Collection Form Submit
    const editForm = document.getElementById('editCollectionForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitEditCollection();
        });
    }
    
    // Copy Share URL
    const copyBtn = document.getElementById('copyShareUrl');
    if (copyBtn) {
        copyBtn.addEventListener('click', function() {
            const urlInput = document.getElementById('shareCollectionUrl');
            urlInput.select();
            document.execCommand('copy');
            
            // Show feedback
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            copyBtn.classList.add('btn-success');
            copyBtn.classList.remove('btn-outline-secondary');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-secondary');
            }, 2000);
        });
    }
});

let currentCollectionId = null;

function handleEditCollection(button) {
    console.log('âœï¸ Edit collection clicked');
    
    const collectionId = button.dataset.collectionId;
    const collectionName = button.dataset.collectionName;
    const collectionDescription = button.dataset.collectionDescription;
    const isPublic = button.dataset.collectionPublic === 'true';
    
    currentCollectionId = collectionId;
    
    // Fill form
    document.getElementById('editCollectionName').value = collectionName;
    document.getElementById('editCollectionDescription').value = collectionDescription || '';
    document.getElementById('editIsPublic').checked = isPublic;
    
    // Update form action
    const form = document.getElementById('editCollectionForm');
    form.action = `/studio/collections/${collectionId}/edit/`;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editCollectionModal'));
    modal.show();
}

function handleDeleteCollection(button) {
    console.log('ðŸ—‘ï¸ Delete collection clicked');
    
    const collectionId = button.dataset.collectionId;
    const collectionName = button.dataset.collectionName;
    
    currentCollectionId = collectionId;
    
    // Update modal content
    document.getElementById('deleteCollectionName').textContent = collectionName;
    
    // Set up confirm button
    const confirmBtn = document.getElementById('confirmDeleteCollectionBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.addEventListener('click', function() {
        executeDeleteCollection(collectionId);
    });
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deleteCollectionModal'));
    modal.show();
}

function handleShareCollection(button) {
    console.log('ðŸ“¤ Share collection clicked');
    
    const collectionId = button.dataset.collectionId;
    
    // Generate share URL (you may want to implement a proper sharing system)
    const shareUrl = `${window.location.origin}/studio/collections/${collectionId}/`;
    document.getElementById('shareCollectionUrl').value = shareUrl;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('shareCollectionModal'));
    modal.show();
}

async function submitEditCollection() {
    console.log('ðŸ’¾ Submitting collection edit...');
    
    if (!currentCollectionId) return;
    
    const form = document.getElementById('editCollectionForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch(`/studio/collections/${currentCollectionId}/edit/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editCollectionModal'));
            modal.hide();
            
            showToast(data.message, 'success');
            
            // Refresh the page to show updated collection
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Error updating collection');
        }
    } catch (error) {
        console.error('âŒ Edit collection error:', error);
        showToast('Error updating collection: ' + error.message, 'error');
    }
}

async function executeDeleteCollection(collectionId) {
    console.log(`ðŸ—‘ï¸ Executing collection delete ${collectionId}...`);
    
    try {
        const response = await fetch(`/studio/collections/${collectionId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteCollectionModal'));
            modal.hide();
            
            showToast(data.message, 'success');
            
            // Redirect or refresh
            if (data.redirect_url) {
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1500);
            } else {
                location.reload();
            }
        } else {
            throw new Error(data.error || 'Delete failed');
        }
    } catch (error) {
        console.error('âŒ Delete collection error:', error);
        showToast('Error deleting collection: ' + error.message, 'error');
    }
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
           document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
           document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
}

function showToast(message, type = 'info') {
    // Remove any existing toasts
    const existingToasts = document.querySelectorAll('.custom-toast');
    existingToasts.forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed custom-toast`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 350px; animation: slideInRight 0.3s ease;';
    
    const icon = type === 'success' ? 'check-circle-fill' : 
                 type === 'error' ? 'exclamation-triangle-fill' : 
                 'info-circle-fill';
    
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${icon} me-2"></i>
            <div>${message}</div>
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}
</script>