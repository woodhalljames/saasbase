<!-- saas_base/templates/wedding_shopping/couple_manage.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-md-8">
      <h1>{{ title }}</h1>
      <p class="text-muted">Create and manage your public wedding page</p>
    </div>
    <div class="col-md-4 text-end">
      {% if object %}
        <a href="{{ object.get_public_url }}" 
           class="btn btn-success me-2" 
           target="_blank">
          <i class="bi bi-eye"></i> View Public Page
        </a>
        <button class="btn btn-outline-secondary" 
                onclick="copyToClipboard('{{ object.get_public_url }}')">
          <i class="bi bi-share"></i> Copy Link
        </button>
      {% endif %}
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" id="coupleForm">
    {% csrf_token %}
    
    <div class="row">
      <!-- Main Form -->
      <div class="col-lg-8">
        
        <!-- Basic Information -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-heart"></i> Couple Information</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="{{ form.partner_1_name.id_for_label }}" class="form-label">First Partner's Name</label>
                {{ form.partner_1_name }}
                {% if form.partner_1_name.errors %}
                  <div class="text-danger">{{ form.partner_1_name.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.partner_2_name.id_for_label }}" class="form-label">Second Partner's Name</label>
                {{ form.partner_2_name }}
                {% if form.partner_2_name.errors %}
                  <div class="text-danger">{{ form.partner_2_name.errors }}</div>
                {% endif %}
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="{{ form.wedding_date.id_for_label }}" class="form-label">Wedding Date</label>
                {{ form.wedding_date }}
                {% if form.wedding_date.errors %}
                  <div class="text-danger">{{ form.wedding_date.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-4 mb-3">
                <label for="{{ form.venue_name.id_for_label }}" class="form-label">Venue Name</label>
                {{ form.venue_name }}
                {% if form.venue_name.errors %}
                  <div class="text-danger">{{ form.venue_name.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-4 mb-3">
                <label for="{{ form.venue_location.id_for_label }}" class="form-label">Venue Location</label>
                {{ form.venue_location }}
                {% if form.venue_location.errors %}
                  <div class="text-danger">{{ form.venue_location.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Photos -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-images"></i> Photos</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="{{ form.couple_photo.id_for_label }}" class="form-label">Couple Photo</label>
                {{ form.couple_photo }}
                {% if object.couple_photo %}
                  <div class="mt-2">
                    <img src="{{ object.couple_photo.url }}" 
                         class="img-thumbnail" 
                         style="max-width: 200px;"
                         alt="Current couple photo">
                  </div>
                {% endif %}
                {% if form.couple_photo.errors %}
                  <div class="text-danger">{{ form.couple_photo.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ form.venue_photo.id_for_label }}" class="form-label">Venue Photo</label>
                {{ form.venue_photo }}
                {% if object.venue_photo %}
                  <div class="mt-2">
                    <img src="{{ object.venue_photo.url }}" 
                         class="img-thumbnail" 
                         style="max-width: 200px;"
                         alt="Current venue photo">
                  </div>
                {% endif %}
                {% if form.venue_photo.errors %}
                  <div class="text-danger">{{ form.venue_photo.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Love Story -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-chat-heart"></i> Your Love Story</h5>
          </div>
          <div class="card-body">
            <label for="{{ form.couple_story.id_for_label }}" class="form-label">Tell Your Story</label>
            {{ form.couple_story }}
            {% if form.couple_story.errors %}
              <div class="text-danger">{{ form.couple_story.errors }}</div>
            {% endif %}
          </div>
        </div>

        <!-- Social Media Links -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-share"></i> Social Media</h5>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSocialForm()">
              <i class="bi bi-plus"></i> Add Social Link
            </button>
          </div>
          <div class="card-body">
            <div id="social-formset">
              {{ social_formset.management_form }}
              {% for form in social_formset %}
                <div class="social-form border rounded p-3 mb-3">
                  {% if form.non_field_errors %}
                    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                  {% endif %}
                  
                  <div class="row">
                    <div class="col-md-3 mb-2">
                      <label class="form-label">Platform</label>
                      {{ form.platform }}
                    </div>
                    <div class="col-md-3 mb-2">
                      <label class="form-label">Platform Name</label>
                      {{ form.platform_name }}
                    </div>
                    <div class="col-md-4 mb-2">
                      <label class="form-label">URL</label>
                      {{ form.url }}
                    </div>
                    <div class="col-md-2 mb-2">
                      <label class="form-label">Display Name</label>
                      {{ form.display_name }}
                    </div>
                  </div>
                  
                  <div class="text-end">
                    {% if form.instance.pk %}
                      {{ form.DELETE }}
                      <label for="{{ form.DELETE.id_for_label }}" class="form-check-label text-danger">
                        <i class="bi bi-trash"></i> Delete
                      </label>
                    {% endif %}
                  </div>
                  
                  {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                  {% endfor %}
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Wedding Registries -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-gift"></i> Wedding Registries</h5>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRegistryForm()">
              <i class="bi bi-plus"></i> Add Registry
            </button>
          </div>
          <div class="card-body">
            <div id="registry-formset">
              {{ registry_formset.management_form }}
              {% for form in registry_formset %}
                <div class="registry-form border rounded p-3 mb-3">
                  {% if form.non_field_errors %}
                    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                  {% endif %}
                  
                  <div class="row">
                    <div class="col-md-3 mb-2">
                      <label class="form-label">Registry Type</label>
                      {{ form.registry_type }}
                    </div>
                    <div class="col-md-3 mb-2">
                      <label class="form-label">Registry Name</label>
                      {{ form.registry_name }}
                    </div>
                    <div class="col-md-6 mb-2">
                      <label class="form-label">Registry URL</label>
                      {{ form.original_url }}
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6 mb-2">
                      <label class="form-label">Display Name</label>
                      {{ form.display_name }}
                    </div>
                    <div class="col-md-6 mb-2">
                      <label class="form-label">Description</label>
                      {{ form.description }}
                    </div>
                  </div>
                  
                  <div class="text-end">
                    {% if form.instance.pk %}
                      {{ form.DELETE }}
                      <label for="{{ form.DELETE.id_for_label }}" class="form-check-label text-danger">
                        <i class="bi bi-trash"></i> Delete
                      </label>
                    {% endif %}
                  </div>
                  
                  {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                  {% endfor %}
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Photo Collections -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-collection"></i> Wedding Venue Collections</h5>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPhotoForm()">
              <i class="bi bi-plus"></i> Add Collection
            </button>
          </div>
          <div class="card-body">
            {% if user_collections %}
              <div class="alert alert-info">
                <strong>Your Collections:</strong>
                {% for collection in user_collections %}
                  <span class="badge bg-primary me-1">{{ collection.name }} (ID: {{ collection.id }})</span>
                {% endfor %}
              </div>
            {% endif %}
            
            <div id="photo-formset">
              {{ photo_formset.management_form }}
              {% for form in photo_formset %}
                <div class="photo-form border rounded p-3 mb-3">
                  {% if form.non_field_errors %}
                    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                  {% endif %}
                  
                  <div class="row">
                    <div class="col-md-4 mb-2">
                      <label class="form-label">Collection Name</label>
                      {{ form.collection_name }}
                    </div>
                    <div class="col-md-3 mb-2">
                      <label class="form-label">Studio Collection ID</label>
                      {{ form.studio_collection_id }}
                    </div>
                    <div class="col-md-3 mb-2">
                      <div class="form-check mt-4">
                        {{ form.is_featured }}
                        <label for="{{ form.is_featured.id_for_label }}" class="form-check-label">
                          Featured
                        </label>
                      </div>
                    </div>
                    <div class="col-md-2 text-end">
                      {% if form.instance.pk %}
                        {{ form.DELETE }}
                        <label for="{{ form.DELETE.id_for_label }}" class="form-check-label text-danger">
                          <i class="bi bi-trash"></i> Delete
                        </label>
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-12 mb-2">
                      <label class="form-label">Description</label>
                      {{ form.description }}
                    </div>
                  </div>
                  
                  {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                  {% endfor %}
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        <!-- Privacy Settings -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-shield-check"></i> Privacy & Sharing</h5>
          </div>
          <div class="card-body">
            <div class="form-check mb-3">
              {{ form.is_public }}
              <label for="{{ form.is_public.id_for_label }}" class="form-check-label">
                Make page publicly discoverable
              </label>
              <div class="form-text">
                When enabled, your page can be found in public listings and search engines.
              </div>
            </div>
            
            {% if object %}
              <hr>
              <div class="mb-3">
                <label class="form-label">Share URL</label>
                <div class="input-group">
                  <input type="text" 
                         class="form-control" 
                         value="{{ object.get_public_url }}" 
                         readonly 
                         id="shareUrl">
                  <button class="btn btn-outline-secondary" 
                          type="button" 
                          onclick="copyToClipboard('{{ object.get_public_url }}')">
                    <i class="bi bi-clipboard"></i>
                  </button>
                </div>
                <div class="form-text">
                  This private link can be shared with anyone, regardless of privacy settings.
                </div>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <a href="{% url 'image_processing:wedding_studio' %}" class="btn btn-outline-primary">
                <i class="bi bi-magic"></i> Create Wedding Transformations
              </a>
              <a href="{% url 'image_processing:collections_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-collection"></i> Manage Collections
              </a>
              {% if object %}
                <a href="{{ object.get_public_url }}" class="btn btn-outline-success" target="_blank">
                  <i class="bi bi-eye"></i> Preview Public Page
                </a>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Save Button -->
        <div class="card">
          <div class="card-body">
            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-save"></i> Save Wedding Page
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
// Copy to clipboard functionality
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <i class="bi bi-check-circle"></i> Link copied to clipboard!
            <button type="button" class="btn-close ms-2" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 3000);
    });
}

// Dynamic formset management
function addSocialForm() {
    // This would need to be implemented with proper Django formset management
    console.log('Add social form - implement formset management');
}

function addRegistryForm() {
    // This would need to be implemented with proper Django formset management
    console.log('Add registry form - implement formset management');
}

function addPhotoForm() {
    // This would need to be implemented with proper Django formset management
    console.log('Add photo form - implement formset management');
}

// Form validation and enhancement
document.addEventListener('DOMContentLoaded', function() {
    // Platform name field visibility based on selection
    document.querySelectorAll('select[name*="platform"]').forEach(select => {
        const container = select.closest('.social-form');
        const platformNameField = container.querySelector('input[name*="platform_name"]');
        
        function togglePlatformName() {
            if (select.value === 'other') {
                platformNameField.style.display = 'block';
                platformNameField.required = true;
            } else {
                platformNameField.style.display = 'none';
                platformNameField.required = false;
            }
        }
        
        select.addEventListener('change', togglePlatformName);
        togglePlatformName(); // Initial call
    });
    
    // Registry name field visibility
    document.querySelectorAll('select[name*="registry_type"]').forEach(select => {
        const container = select.closest('.registry-form');
        const registryNameField = container.querySelector('input[name*="registry_name"]');
        
        function toggleRegistryName() {
            if (select.value === 'other') {
                registryNameField.style.display = 'block';
                registryNameField.required = true;
            } else {
                registryNameField.style.display = 'none';
                registryNameField.required = false;
            }
        }
        
        select.addEventListener('change', toggleRegistryName);
        toggleRegistryName(); // Initial call
    });
});
</script>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
{% endblock %}